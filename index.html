<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- ============================================
         ë©”íƒ€ ì •ë³´ ë° ì™¸ë¶€ ë¦¬ì†ŒìŠ¤
         ============================================ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Stock Manager</title>
    
    <!-- PWA ì„¤ì • (ëª¨ë°”ì¼ ì•±ì²˜ëŸ¼ ì‚¬ìš© ê°€ëŠ¥) -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" href="./icon-192.png">
    
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬: ë„ë„›/ë¼ì¸ ì°¨íŠ¸ ê·¸ë¦¬ê¸°ìš© -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js ë°ì´í„° ë¼ë²¨ í”ŒëŸ¬ê·¸ì¸ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸ìš© í”ŒëŸ¬ê·¸ì¸ -->
    <style>
        /* ============================================
           CSS ë³€ìˆ˜ ì •ì˜ (ì „ì—­ ìƒ‰ìƒ í…Œë§ˆ)
           - ì—¬ê¸°ì„œ ìƒ‰ìƒì„ ë³€ê²½í•˜ë©´ ì „ì²´ ì•± ìƒ‰ìƒì´ ë°”ë€ë‹ˆë‹¤
           ============================================ */
        :root {
            --primary: #007AFF;      /* ë©”ì¸ íŒŒë€ìƒ‰ (ë²„íŠ¼, í™œì„± íƒ­) */
            --bg: #F2F4F8;          /* ë°°ê²½ìƒ‰ (ì—°í•œ íšŒìƒ‰) */
            --card-bg: #FFFFFF;     /* ì¹´ë“œ ë°°ê²½ìƒ‰ (í°ìƒ‰) */
            --text-main: #333;      /* ì£¼ í…ìŠ¤íŠ¸ (ì§„í•œ íšŒìƒ‰) */
            --text-sub: #666;       /* ë³´ì¡° í…ìŠ¤íŠ¸ (ì¤‘ê°„ íšŒìƒ‰) */
            --up: #FF3B30;          /* ìƒìŠ¹/ìˆ˜ìµ (ë¹¨ê°•) */
            --down: #007AFF;        /* í•˜ë½/ì†ì‹¤ (íŒŒë‘) */
            --nav-height: 60px;     /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë†’ì´ */
            --border-color: #eee;   /* í…Œë‘ë¦¬ ìƒ‰ìƒ */
            --divider-color: #eee;  /* êµ¬ë¶„ì„  ìƒ‰ìƒ */
        }
        
        /* ë‹¤í¬ëª¨ë“œ */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #0A84FF;      /* ë°ì€ íŒŒë€ìƒ‰ */
                --bg: #000000;           /* ì§„í•œ ê²€ì • ë°°ê²½ */
                --card-bg: #1C1C1E;      /* ì¹´ë“œ ë°°ê²½ (ë‹¤í¬ ê·¸ë ˆì´) */
                --text-main: #FFFFFF;    /* ì£¼ í…ìŠ¤íŠ¸ (í°ìƒ‰) */
                --text-sub: #98989D;     /* ë³´ì¡° í…ìŠ¤íŠ¸ (ì—°í•œ íšŒìƒ‰) */
                --up: #FF453A;           /* ìƒìŠ¹/ìˆ˜ìµ (ë°ì€ ë¹¨ê°•) */
                --down: #0A84FF;         /* í•˜ë½/ì†ì‹¤ (ë°ì€ íŒŒë‘) */
                --border-color: #38383A; /* í…Œë‘ë¦¬ ìƒ‰ìƒ */
                --divider-color: #38383A;/* êµ¬ë¶„ì„  ìƒ‰ìƒ */
            }
        }
        
        /* ê°•ì œ ë‹¤í¬ëª¨ë“œ í´ë˜ìŠ¤ (ìˆ˜ë™ í† ê¸€ìš©) */
        body.dark-mode {
            --primary: #0A84FF;
            --bg: #000000;
            --card-bg: #1C1C1E;
            --text-main: #FFFFFF;
            --text-sub: #98989D;
            --up: #FF453A;
            --down: #0A84FF;
            --border-color: #38383A;
            --divider-color: #38383A;
        }
        
        /* ê°•ì œ ë¼ì´íŠ¸ëª¨ë“œ í´ë˜ìŠ¤ (ìˆ˜ë™ í† ê¸€ìš©) */
        body.light-mode {
            --primary: #007AFF;
            --bg: #F2F4F8;
            --card-bg: #FFFFFF;
            --text-main: #333;
            --text-sub: #666;
            --up: #FF3B30;
            --down: #007AFF;
            --border-color: #eee;
            --divider-color: #eee;
        }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text-main); padding-bottom: var(--nav-height); -webkit-tap-highlight-color: transparent; }
        
        /* í—¤ë” */
        header { 
            background: var(--card-bg); 
            padding: 15px 20px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 1px 5px rgba(0,0,0,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            gap: 10px;
        }
        
        h1 { 
            margin: 0; 
            font-size: 18px; 
            font-weight: 700; 
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        select#userSelect { 
            padding: 5px 10px; 
            border-radius: 15px; 
            border: 1px solid var(--border-color); 
            font-size: 14px; 
            background: var(--card-bg); 
            color: var(--text-main);
            outline: none;
            flex-shrink: 1;
            max-width: 60%;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; display: none; }
        .container.active { display: block; }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .card h3 { margin: 0 0 15px 0; font-size: 16px; color: var(--text-sub); }
        
        /* í…ìŠ¤íŠ¸ ìœ í‹¸ */
        .big-text { font-size: 28px; font-weight: 800; margin: 5px 0; }
        .sub-text { font-size: 14px; color: var(--text-sub); }
        .up { color: var(--up); }
        .down { color: var(--down); }
        .flex-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .divider { border-top: 1px solid var(--divider-color); margin: 15px 0; }

        /* ë„ë„› ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .chart-container { position: relative; height: 250px; width: 100%; }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .stock-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .stock-item:last-child { border-bottom: none; }
        .stock-name { font-weight: 600; font-size: 15px; }
        .stock-ticker { font-size: 12px; color: #888; margin-top: 2px; }
        .stock-price { font-weight: 600; text-align: right; }
        .stock-change { font-size: 12px; text-align: right; margin-top: 2px; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-wrap { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
       th, td { padding: 10px; text-align: right; border-bottom: 1px solid var(--border-color); }
    
        /* âœ… ê¶Œì¥: ìŠ¤í¬ë¡¤ ì‹œ í—¤ë” ê³ ì • */
        th { 
            text-align: center; 
            background: var(--card-bg); 
            font-weight: 600; 
            color: var(--text-sub);
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--border-color);
        } 
        td:first-child { text-align: left; font-weight: 600; background: var(--card-bg); }
    
        /* ê±°ë˜ë‚´ì—­ í¼ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-sub); }
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 16px; 
            box-sizing: border-box;
            background: var(--card-bg);
            color: var(--text-main);
        }
        button.btn-primary { width: 100%; background: var(--primary); color: white; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        button.btn-primary:active { opacity: 0.9; }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--card-bg);
            height: var(--nav-height);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
        }
        .nav-item {
            flex: 1;
            text-align: center;
            font-size: 9px;
            color: #999;
            cursor: pointer;
            padding: 4px 0;
            min-width: 0;
        }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-icon { font-size: 16px; display: block; margin-bottom: 1px; }

        /* ë¡œë”© í™”ë©´ */
        #loader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--bg); 
            z-index: 200; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        #loadingText {
            color: var(--text-main);
            margin-top: 10px;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ê±°ë˜ë‚´ì—­ í•„í„° ì˜ì—­ */
        .history-filter {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            align-items: center;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .history-filter input {
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 4px;
            font-size: 13px;
            width: 110px;
            background: var(--bg);
            color: var(--text-main);
        }
        .history-filter button {
            background: #333;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        /* ìœ í˜•ë³„ ì»¬ëŸ¬ ë°°ì§€ */
        .badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 6px;
            color: white;
            min-width: 30px;
            text-align: center;
        }
        .badge.buy { background-color: #ff3b30; }
        .badge.sell { background-color: #007aff; }
        .badge.deposit { background-color: #ff9500; }
        .badge.withdraw { background-color: #5856d6; }
        .badge.div { background-color: #ffcc00; color: #333; }
        
        .ticker-text {
            font-size: 12px;
            color: #888;
            margin-left: 4px;
            font-weight: normal;
        }

        /* ì˜ˆìˆ˜ê¸ˆ ìˆ˜ì • ë²„íŠ¼ */
        .edit-cash-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
        }
        .edit-cash-btn:active {
            opacity: 0.8;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: var(--card-bg);
            margin: 15% auto;
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .modal-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-main);
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: var(--text-sub);
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background: var(--bg);
            color: var(--text-main);
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-cancel, .btn-save {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-cancel {
            background: var(--border-color);
            color: var(--text-main);
        }
        .btn-save {
            background: var(--primary);
            color: white;
        }
        .btn-save:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* ============================================
           ì°¨íŠ¸ íƒ­ ìŠ¤íƒ€ì¼
           ============================================ */
        .chart-ticker-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .chart-ticker-scroll::-webkit-scrollbar { display: none; }

        .ticker-btn {
            flex-shrink: 0;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-main);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .ticker-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .period-btns {
            display: flex;
            gap: 6px;
            margin: 12px 0;
        }
        .period-btn {
            flex: 1;
            padding: 7px 0;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-sub);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .period-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .candle-wrap {
            position: relative;
            width: 100%;
            height: 340px;
            touch-action: none;
            user-select: none;
        }

        .chart-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 12px;
            color: var(--text-sub);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
        }
        .avg-price-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 10px;
            background: rgba(0,122,255,0.12);
            color: var(--primary);
            font-weight: 700;
            font-size: 12px;
        }
        #chartLoadingMsg {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-sub);
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="loginModal" style="
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 9999;
    display: flex; justify-content: center; align-items: center;
    backdrop-filter: blur(5px);
">
    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; width: 80%; max-width: 300px;">
        <h3>ğŸ”’ ê°€ì¡± ë¡œê·¸ì¸</h3>
        <p style="font-size: 14px; color: #666; margin-bottom: 20px;">ê°€ì¡± ì•”í˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        <input type="password" id="inputPass" placeholder="ì•”í˜¸ ì…ë ¥" 
            style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">
        <button onclick="tryLogin()" 
            style="width: 100%; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px;">
            í™•ì¸
        </button>
        <button onclick="localStorage.clear(); location.reload();"
            style="width:100%; margin-top:10px; padding:8px; background:none; border:none; color:#aaa; font-size:12px; cursor:pointer;">
            â†º ìºì‹œ ì´ˆê¸°í™” í›„ ì¬ì‹œë„
        </button>
    </div>
</div>

<div id="loader">
    <div class="spinner"></div>
    <div id="loadingText">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<header>
    <h1>íˆ¬ì ê´€ë¦¬</h1>
    <div style="display: flex; align-items: center; gap: 10px;">
        <select id="userSelect" onchange="changeUser()">
            <option value="ìœ¤ì„±ì¼">ìœ¤ì„±ì¼ (ì•„ë¹ )</option>
            <option value="ìœ¤ì±„í˜„">ìœ¤ì±„í˜„ (ë”¸)</option>
            <option value="ìœ¤ì‹œí™˜">ìœ¤ì‹œí™˜ (ì•„ë“¤)</option>
            <option value="ê°€ì¡±ì „ì²´">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± ì „ì²´</option>
        </select>
        <button onclick="toggleTheme()" id="themeToggle" style="
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        " title="í…Œë§ˆ ë³€ê²½">ğŸŒ“</button>
        <button onclick="forceRefresh()" style="
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        " title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
    </div>
</header>

<div id="tab-portfolio" class="container active">
    <div class="card">
        <h3>ì˜¤ëŠ˜ì˜ ìì‚°</h3>
        <div class="big-text" id="totalAsset">0ì›</div>
        
        <div class="flex-row">
            <span class="sub-text">ì´ ì†ìµ</span>
            <span id="totalProfit" class="up">0ì› (0%)</span>
        </div>
        
        <div class="flex-row">
            <span class="sub-text">ì˜¤ëŠ˜ ì†ìµ</span>
            <span id="todayProfit" class="up">0ì› (0%)</span>
        </div>
        <div class="divider"></div>
        <div class="flex-row">
            <span class="sub-text">ì˜ˆìˆ˜ê¸ˆ</span>
            <span>
                <span id="cashHoldings">0ì›</span>
                <button class="edit-cash-btn" onclick="openCashEditModal()">ìˆ˜ì •</button>
            </span>
        </div>
        <div class="flex-row"><span class="sub-text">ì£¼ì‹ í‰ê°€ê¸ˆ</span><span id="stockHoldings">0ì›</span></div>
    </div>

    <div class="card">
        <h3>ìì‚° ë¹„ì¤‘</h3>
        <div class="chart-container">
            <canvas id="donutChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>ë³´ìœ  ì¢…ëª©</h3>
        <div id="stockList"></div>
    </div>
</div>

<div id="tab-performance" class="container">
    <div class="card">
        <h3>ë²¤ì¹˜ë§ˆí‚¹ ë¹„êµ (ëˆ„ì  ìˆ˜ìµë¥ )</h3>
        <div class="sub-text" style="margin-bottom:10px; font-size:12px;">* ê¸°ê°„ë³„ ì‹œê°„ê°€ì¤‘ ìˆ˜ìµë¥  ì§€ìˆ˜í™” (ì‹œì‘ì¼=1000)</div>
        <div class="chart-container">
            <canvas id="lineChart"></canvas>
        </div>
    </div>
    
    <div class="card">
        <h3>ì—°ë„ë³„ ì†ìµ</h3>
        <select id="yearSelect" onchange="renderRealizedDetail()" style="margin-bottom:10px; padding:5px;">
            <option value="2025">2025ë…„</option>
        </select>
        <div id="realizedProfitList"></div>
    </div>
</div>

<div id="tab-balance" class="container">
    <div class="card">
        <h3>ìƒì„¸ ì”ê³ </h3>
        <div class="table-wrap">
            <table id="balanceTable">
                <thead>
                    <tr>
                        <th>ì¢…ëª©ëª…</th>
                        <th>í‰ê°€ì†ìµ(ì›)</th>
                        <th>ìˆ˜ìµë¥ </th>
                        <th>ì˜¤ëŠ˜ë³€ë™</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>í‰ë‹¨ê°€</th>
                        <th>í˜„ì¬ê°€</th>
                        <th>í‰ê°€ê¸ˆì•¡</th>
                        <th>ë¹„ì¤‘</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="tab-history" class="container">
    <div class="card">
        <h3>ê±°ë˜ ì¶”ê°€</h3>
        <div class="form-group">
            <label>ë‚ ì§œ</label>
            <input type="date" id="inputDate">
        </div>
        <div class="form-group">
            <label>ê±°ë˜ì</label>
            <select id="inputUser">
                <option value="ìœ¤ì„±ì¼">ìœ¤ì„±ì¼</option>
                <option value="ìœ¤ì±„í˜„">ìœ¤ì±„í˜„</option>
                <option value="ìœ¤ì‹œí™˜">ìœ¤ì‹œí™˜</option>
            </select>
        </div>
        <div class="form-group">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>í‹°ì»¤</label>
                    <input type="text" id="inputTicker" placeholder="AAPL" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div style="flex:1;">
                    <label>ìœ í˜•</label>
                    <select id="inputType">
                        <option value="ë§¤ìˆ˜">ë§¤ìˆ˜</option>
                        <option value="ë§¤ë„">ë§¤ë„</option>
                        <option value="ì…ê¸ˆ">ì…ê¸ˆ</option>
                        <option value="ì¶œê¸ˆ">ì¶œê¸ˆ</option>
                        <option value="ë°°ë‹¹">ë°°ë‹¹</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>ì¢…ëª©ëª…</label>
            <input type="text" id="inputName" placeholder="ì• í”Œ">
        </div>
        <div class="form-group">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>ìˆ˜ëŸ‰</label>
                    <input type="number" id="inputQty" placeholder="0">
                </div>
                <div style="flex:1;">
                    <label>ë‹¨ê°€/ê¸ˆì•¡</label>
                    <input type="number" id="inputPrice" placeholder="USD/KRW">
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>í™˜ìœ¨ (ì…ë ¥ ì•ˆí•˜ë©´ ìë™)</label>
            <input type="number" id="inputFx" placeholder="ì˜ˆ: 1400">
        </div>
        <div class="form-group">
            <label>ë§¤ë§¤ì¼ì§€</label>
            <textarea id="inputMemo" rows="2"></textarea>
        </div>
        <button class="btn-primary" onclick="submitTransaction()">ê±°ë˜ ì €ì¥</button>
    </div>

    <div class="card">
        <h3>ìµœê·¼ ê±°ë˜ ë‚´ì—­</h3>
        
        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="date" id="startDate" style="flex:1; padding: 8px; border: 1px solid #ddd; border-radius: 8px;">
                <span>~</span>
                <input type="date" id="endDate" style="flex:1; padding: 8px; border: 1px solid #ddd; border-radius: 8px;">
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="filterHistory()" style="flex: 1; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold;">ì¡°íšŒ</button>
                <button onclick="resetHistory()" style="flex: 1; padding: 10px; background: #999; color: white; border: none; border-radius: 8px; font-weight: bold;">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div id="historyList">
            <p style="text-align:center; color:#999;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>
</div>

<nav>
    <div class="nav-item active" onclick="switchTab('portfolio')">
        <span class="nav-icon">ğŸ“Š</span>í™ˆ
    </div>
    <div class="nav-item" onclick="switchTab('performance')">
        <span class="nav-icon">ğŸ“ˆ</span>ì„±ê³¼
    </div>
    <div class="nav-item" onclick="switchTab('balance')">
        <span class="nav-icon">ğŸ’°</span>ì”ê³ 
    </div>
    <div class="nav-item" onclick="switchTab('history')">
        <span class="nav-icon">ğŸ“</span>ë‚´ì—­
    </div>
    <div class="nav-item" onclick="switchTab('chart')">
        <span class="nav-icon">ğŸ•¯ï¸</span>ì°¨íŠ¸
    </div>
</nav>

<!-- ì°¨íŠ¸ íƒ­ -->
<div id="tab-chart" class="container">
    <div class="card">
        <h3>ì¢…ëª© ì°¨íŠ¸</h3>
        <div class="chart-ticker-scroll" id="tickerBtnList">
            <span style="color:var(--text-sub); font-size:13px; padding:8px 0;">ì¢…ëª© ë¡œë”© ì¤‘...</span>
        </div>
    </div>

    <div class="card" id="candleChartCard" style="display:none;">
        <div class="chart-info-bar">
            <span id="chartTickerLabel" style="font-weight:700; font-size:15px;"></span>
            <span class="avg-price-badge" id="avgPriceBadge"></span>
        </div>
        <div class="period-btns">
            <button class="period-btn" onclick="setPeriod(1)">1ê°œì›”</button>
            <button class="period-btn" onclick="setPeriod(3)">3ê°œì›”</button>
            <button class="period-btn active" onclick="setPeriod(6)">6ê°œì›”</button>
            <button class="period-btn" onclick="setPeriod(12)">1ë…„</button>
            <button class="period-btn" onclick="setPeriod(0)">ì „ì²´</button>
        </div>
        <div class="candle-wrap">
            <canvas id="candleChart"></canvas>
        </div>
        <div style="margin-top:12px; font-size:11px; color:var(--text-sub); text-align:center;">
            ğŸ‘† ë“œë˜ê·¸ë¡œ ì´ë™ Â· ë‘ ì†ê°€ë½ìœ¼ë¡œ í•€ì¹˜ ì¤Œ
        </div>
    </div>

    <div id="chartLoadingMsg" style="display:none;">
        <div class="spinner" style="margin:0 auto 10px;"></div>
        <div>ì°¨íŠ¸ ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>
</div>

<!-- ì˜ˆìˆ˜ê¸ˆ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="cashEditModal" class="modal">
    <div class="modal-content">
        <h3>ì˜ˆìˆ˜ê¸ˆ ì”ê³  ìˆ˜ì •</h3>
        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
            í˜„ì¬ ì‹¤ì œ ê³„ì¢Œì— ìˆëŠ” í˜„ê¸ˆ ì”ê³ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
            ì…ë ¥í•œ ê¸ˆì•¡ìœ¼ë¡œ ì¥ë¶€ê°€ ìë™ ë³´ì •ë©ë‹ˆë‹¤.
        </p>
        
        <div class="input-group">
            <label>ì›í™” ì˜ˆìˆ˜ê¸ˆ (KRW)</label>
            <input type="number" id="edit-krw" placeholder="ì˜ˆ: 1000000">
        </div>
        
        <div class="input-group">
            <label>ë‹¬ëŸ¬ ì˜ˆìˆ˜ê¸ˆ (USD)</label>
            <input type="number" id="edit-usd" step="0.01" placeholder="ì˜ˆ: 50.25">
        </div>
        
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeCashEditModal()">ì·¨ì†Œ</button>
            <button class="btn-save" onclick="saveCashEdit()">ì €ì¥</button>
        </div>
    </div>
</div>

<script>
    // ============================================
    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ë¶€
    // â€» ìˆ˜ì • ì‹œ ì£¼ì˜: ì´ ë³€ìˆ˜ë“¤ì€ ì•± ì „ì²´ì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤
    // ============================================
    
    /**
     * CURRENT_EXCHANGE_RATE
     * - í˜„ì¬ í™˜ìœ¨ (USD/KRW)
     * - ê¸°ë³¸ê°’: 1450ì›
     * - ìë™ ì—…ë°ì´íŠ¸: processMarketData()ì—ì„œ ì‹œì¥ ë°ì´í„°ì˜ ìµœì‹  í™˜ìœ¨ë¡œ ê°±ì‹ 
     * - ì‚¬ìš©ì²˜: ë¯¸êµ­ ì£¼ì‹ ê±°ë˜ë‚´ì—­ì˜ ì›í™” í™˜ì‚°
     */
    let CURRENT_EXCHANGE_RATE = 1450;
    
    /**
     * GOOGLE_SCRIPT_URL
     * - êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ URL
     * - âš ï¸ ì¤‘ìš”: ì—¬ê¸°ì— ë³¸ì¸ì˜ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì›¹ ì•± URLì„ ì…ë ¥í•˜ì„¸ìš”
     * - í˜•ì‹: https://script.google.com/macros/s/[ìŠ¤í¬ë¦½íŠ¸ID]/exec
     * - ì—­í• : ë°ì´í„° ì½ê¸°(GET) ë° ê±°ë˜ ì €ì¥(POST)
     */
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwwJAx9Xa3uHMb-aEAUkO0cPRPl88bRnSApjRwbgtyRQs0cIbNXCOXdj0w5js5KwpYNTA/exec";

    /**
     * [ë³´ì•ˆ] ë¡œê·¸ì¸ ë° ì¸ì¦ ê´€ë ¨ ë³€ìˆ˜
     */
    const STORAGE_KEY = "family_app_auth_key"; // ë¸Œë¼ìš°ì € ì €ì¥ì†Œ í‚¤ ì´ë¦„
    let currentAuthKey = localStorage.getItem(STORAGE_KEY); // ì €ì¥ëœ ì•”í˜¸ ë¶ˆëŸ¬ì˜¤ê¸°

    /**
     * ë°ì´í„° ì €ì¥ìš© ì „ì—­ ë³€ìˆ˜ë“¤
     * - ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ì €ì¥
     * - ì‚¬ìš©ì ë³€ê²½ ì‹œ ì¬ê³„ì‚°ì— ì‚¬ìš©
     */
    let LAST_FETCHED_DATA = null;   // ì„œë²„ ì‘ë‹µ ì›ë³¸ (ë°±ì—…ìš©)
    let RAW_DATA = [];              // ê±°ë˜ ë‚´ì—­ (logs ì‹œíŠ¸ ë°ì´í„°)
    let MARKET_DATA = [];           // ì‹œì¥ ë°ì´í„° (market ì‹œíŠ¸: ì£¼ê°€, í™˜ìœ¨, ì§€ìˆ˜)
    let PERFORMANCE_DATA = [];      // ì„±ê³¼ ë°ì´í„° (ìì‚°ê¸°ë¡ ì‹œíŠ¸)
    let HISTORY_DATA = [];          // ê±°ë˜ ì´ë ¥ (ì˜ˆë¹„, í˜„ì¬ ë¯¸ì‚¬ìš©)
    let currentUser = "ìœ¤ì„±ì¼";     // í˜„ì¬ ì„ íƒëœ ì‚¬ìš©ì (ë“œë¡­ë‹¤ìš´ ê°’)
    let REALIZED_EVENTS = [];       // ì‹¤í˜„ì†ìµ ì´ë²¤íŠ¸ ë°°ì—´ (ë§¤ë„/ë°°ë‹¹ ê¸°ë¡)
    let CURRENT_PRICES = [];
    
    /**
     * ì˜ˆìˆ˜ê¸ˆ ìˆ˜ì • ê´€ë ¨ ë³€ìˆ˜
     * - cashAdjustments: ì‚¬ìš©ìë³„ ì˜ˆìˆ˜ê¸ˆ ìˆ˜ì • ê¸°ë¡ ì €ì¥
     * - í˜•ì‹: { "ìœ¤ì„±ì¼": { krw: 1000000, usd: 500 } }
     */
    let cashAdjustments = {};

    /**
     * Chart.js ê°ì²´ ì €ì¥ìš©
     * - ì°¨íŠ¸ ì¬ìƒì„± ì‹œ ê¸°ì¡´ ì°¨íŠ¸ë¥¼ íŒŒê´´(destroy)í•˜ê¸° ìœ„í•´ í•„ìš”
     * - nullì´ ì•„ë‹ˆë©´ ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆë‹¤ëŠ” ì˜ë¯¸
     */
    let myDonutChart = null;        // ìì‚° ë¹„ì¤‘ ë„ë„› ì°¨íŠ¸
    let myLineChart = null;         // ë²¤ì¹˜ë§ˆí‚¹ ë¼ì¸ ì°¨íŠ¸

    // ============================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    // ============================================
    
    /**
     * showLoading()
     * - ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
     * - í˜¸ì¶œ ì‹œì : ë°ì´í„° ìš”ì²­ ì‹œì‘ ì „
     */
    function showLoading() {
        const loader = document.getElementById('loader');
        if (loader) loader.style.display = 'flex';
    }

    /**
     * hideLoading()
     * - ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
     * - í˜¸ì¶œ ì‹œì : ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ ë˜ëŠ” ì—ëŸ¬ ë°œìƒ ì‹œ
     */
    function hideLoading() {
        const loader = document.getElementById('loader');
        if (loader) loader.style.display = 'none';
    }

    // ============================================
    // [ë³´ì•ˆ] ë¡œê·¸ì¸ ë¡œì§ ì¶”ê°€
    // ============================================
    function tryLogin() {
        try {
            const inputEl = document.getElementById('inputPass');
            if (!inputEl) { alert("ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            const input = inputEl.value;
            if (!input) {
                alert("ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }
            
            // ì•”í˜¸ë¥¼ ë¸Œë¼ìš°ì €ì— ì €ì¥í•˜ê³  í™”ë©´ ê°±ì‹ 
            localStorage.setItem(STORAGE_KEY, input);
            currentAuthKey = input;
            
            const loginModal = document.getElementById('loginModal');
            if (loginModal) loginModal.style.display = "none";
            fetchData(); // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘
        } catch(err) {
            alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: " + err.message);
        }
    }

    // ë¡œê·¸ì¸ ì…ë ¥ì°½ ì—”í„°í‚¤ ì§€ì›
    document.addEventListener('DOMContentLoaded', function() {
        const passInput = document.getElementById('inputPass');
        if (passInput) {
            passInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') tryLogin();
            });
        }
    });

    // ============================================
    // ì´ˆê¸°í™” (í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰)
    // ============================================
    
    /**
     * window.onload
     * - ë¸Œë¼ìš°ì €ê°€ HTMLì„ ì™„ì „íˆ ë¡œë“œí•œ í›„ ì‹¤í–‰
     * - [ìˆ˜ì •ë¨] ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸ í›„ ë°ì´í„° ìš”ì²­
     */
    window.onload = function() {
        // ë‚ ì§œ ì„¸íŒ… (ê¸°ì¡´ ê¸°ëŠ¥)
        document.getElementById('inputDate').valueAsDate = new Date();
        
        // ë‹¤í¬ëª¨ë“œ ì„¤ì • ë³µì›
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.className = savedTheme;
            updateThemeIcon();
        }
        
        // [ë³´ì•ˆ] ì•”í˜¸ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ë°ì´í„° ë¡œë“œ, ì—†ìœ¼ë©´ ë¡œê·¸ì¸ì°½ ë„ì›€
        const loginModal = document.getElementById('loginModal');
        // currentAuthKey ì¬í™•ì¸ (í˜¹ì‹œ null ë¬¸ìì—´ì´ ì €ì¥ëœ ê²½ìš° ë°©ì–´)
        currentAuthKey = localStorage.getItem(STORAGE_KEY);
        if (currentAuthKey && currentAuthKey !== 'null' && currentAuthKey.length > 0) {
            if(loginModal) loginModal.style.display = "none";
            fetchData();
        } else {
            if(loginModal) loginModal.style.display = "flex";
        }
    };

    /**
     * í…Œë§ˆ í† ê¸€ í•¨ìˆ˜
     */
    function toggleTheme() {
        const body = document.body;
        
        if (body.classList.contains('dark-mode')) {
            // ë‹¤í¬ëª¨ë“œ â†’ ë¼ì´íŠ¸ëª¨ë“œ
            body.className = 'light-mode';
            localStorage.setItem('theme', 'light-mode');
        } else if (body.classList.contains('light-mode')) {
            // ë¼ì´íŠ¸ëª¨ë“œ â†’ ì‹œìŠ¤í…œ ê¸°ë³¸
            body.className = '';
            localStorage.removeItem('theme');
        } else {
            // ì‹œìŠ¤í…œ ê¸°ë³¸ â†’ ë‹¤í¬ëª¨ë“œ
            body.className = 'dark-mode';
            localStorage.setItem('theme', 'dark-mode');
        }
        
        updateThemeIcon();
    }

    /**
     * í…Œë§ˆ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
     */
    function updateThemeIcon() {
        const btn = document.getElementById('themeToggle');
        if (!btn) return;
        
        const body = document.body;
        if (body.classList.contains('dark-mode')) {
            btn.textContent = 'ğŸŒ™'; // ë‹¤í¬ëª¨ë“œ
            btn.title = 'ë¼ì´íŠ¸ëª¨ë“œë¡œ ì „í™˜';
        } else if (body.classList.contains('light-mode')) {
            btn.textContent = 'â˜€ï¸'; // ë¼ì´íŠ¸ëª¨ë“œ
            btn.title = 'ì‹œìŠ¤í…œ ì„¤ì •ìœ¼ë¡œ ì „í™˜';
        } else {
            btn.textContent = 'ğŸŒ“'; // ì‹œìŠ¤í…œ ê¸°ë³¸
            btn.title = 'ë‹¤í¬ëª¨ë“œë¡œ ì „í™˜';
        }
    }

    // ì‹œì¥ ë°ì´í„° ì²˜ë¦¬
    function processMarketData(data) {
        if (!data || data.length === 0) return [];
        
        let mappedData = data.map(row => {
            return {
                date: row[0],
                ticker: row[1] || '',
                sp500: Number(row[2]) || 0,
                nasdaq: Number(row[3]) || 0,
                kospi: Number(row[4]) || 0,
                usd: Number(row[5]) || 0,
                price: Number(row[6]) || 0
            };
        });

        if (mappedData.length > 0) {
            let lastData = mappedData[mappedData.length - 1];
            if (lastData.usd > 0) {
                CURRENT_EXCHANGE_RATE = lastData.usd;
                console.log("ì˜¤ëŠ˜ì˜ í™˜ìœ¨ ì ìš©: " + CURRENT_EXCHANGE_RATE + "ì›");
            }
        }

        if (typeof renderHistory === 'function') {
            renderHistory();
        }

        return mappedData;
    }

    // ============================================
    // ìºì‹œ ê´€ë ¨ ìƒìˆ˜ ë° í•¨ìˆ˜
    // ============================================
    const CACHE_KEY = 'portfolio_data_cache';
    const CACHE_TIME_KEY = 'portfolio_cache_time';
    const CACHE_VALIDITY_MINUTES = 30; // ìºì‹œ ìœ íš¨ ì‹œê°„ (30ë¶„)

    /**
     * ìºì‹œëœ ë°ì´í„° ë¡œë“œ ë° ì²˜ë¦¬
     */
    function loadFromCache() {
        try {
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cacheTime = localStorage.getItem(CACHE_TIME_KEY);
            
            if (!cachedData || !cacheTime) return false;
            
            const ageMinutes = (Date.now() - Number(cacheTime)) / 60000;
            
            if (ageMinutes > CACHE_VALIDITY_MINUTES) {
                console.log(`ìºì‹œ ë§Œë£Œë¨ (${ageMinutes.toFixed(1)}ë¶„ ê²½ê³¼)`);
                return false;
            }
            
            console.log(`âœ… ìºì‹œ ì‚¬ìš© (${ageMinutes.toFixed(1)}ë¶„ ì „ ë°ì´í„°)`);
            const data = JSON.parse(cachedData);
            applyDataToApp(data);
            return true;
        } catch (e) {
            console.error("ìºì‹œ ë¡œë“œ ì‹¤íŒ¨:", e);
            return false;
        }
    }

    /**
     * ë°ì´í„°ë¥¼ ìºì‹œì— ì €ì¥
     */
    function saveToCache(data) {
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
            localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
            console.log("âœ… ìºì‹œ ì €ì¥ ì™„ë£Œ");
        } catch (e) {
            console.error("ìºì‹œ ì €ì¥ ì‹¤íŒ¨:", e);
            // ì €ì¥ ê³µê°„ ë¶€ì¡± ì‹œ ê¸°ì¡´ ìºì‹œ ì‚­ì œ
            if (e.name === 'QuotaExceededError') {
                localStorage.removeItem(CACHE_KEY);
                localStorage.removeItem(CACHE_TIME_KEY);
            }
        }
    }

    /**
     * ë°ì´í„°ë¥¼ ì•±ì— ì ìš©
     */
    function applyDataToApp(data) {
        if (data.prices) {
            CURRENT_PRICES = data.prices;
        }

        LAST_FETCHED_DATA = data;
        RAW_DATA = data.logs || [];
        
        if (data.market) {
            MARKET_DATA = processMarketData(data.market);
        } else {
            MARKET_DATA = [];
        }
        
        PERFORMANCE_DATA = data.performance || [];
        
        if (RAW_DATA.length > 0) {
            processData(RAW_DATA);
        }
    }

    /**
     * ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì‹¤ì œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­)
     */
    function fetchDataFromServer(isBackground = false) {
        if (!isBackground) {
            console.log("ì„œë²„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
            showLoading();
        } else {
            console.log("ğŸ”„ ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘...");
        }

        if (!GOOGLE_SCRIPT_URL) {
            alert("ì˜¤ë¥˜: GOOGLE_SCRIPT_URL ë³€ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.");
            hideLoading();
            return;
        }

        const requestUrl = `${GOOGLE_SCRIPT_URL}?who=${currentUser}&authKey=${currentAuthKey}`;

        fetch(requestUrl)
            .then(res => {
                if (!res.ok) {
                    throw new Error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (HTTP ìƒíƒœì½”ë“œ: " + res.status + ")");
                }
                return res.text();
            })
            .then(text => {
                if (text.trim().startsWith("<")) {
                    throw new Error("ì„œë²„ì—ì„œ ë°ì´í„° ëŒ€ì‹  HTML(ì—ëŸ¬í˜ì´ì§€)ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.\nì•±ìŠ¤ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ ì£¼ì†Œë¥¼ í™•ì¸í•˜ê±°ë‚˜ 'ìƒˆ ë²„ì „' ë°°í¬ë¥¼ ë‹¤ì‹œ í•´ì£¼ì„¸ìš”.");
                }

                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error("ë°ì´í„°ê°€ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.\në‚´ìš©: " + text.substring(0, 50) + "...");
                }
            })
            .then(data => {
                // [ë³´ì•ˆ ì²´í¬] ì„œë²„ê°€ ì—ëŸ¬ë¥¼ ë³´ëƒˆëŠ”ì§€ í™•ì¸
                if (data.status === 'error') {
                    if(data.message.includes("ë¹„ë°€ë²ˆí˜¸") || data.message.includes("ê¶Œí•œ")) {
                        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ê±°ë‚˜ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                        localStorage.removeItem(STORAGE_KEY);
                        location.reload();
                        return;
                    }
                    throw new Error("ì•±ìŠ¤ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ ì˜¤ë¥˜: " + data.message);
                }

                // ìºì‹œì— ì €ì¥
                saveToCache(data);

                // ì•±ì— ë°ì´í„° ì ìš©
                applyDataToApp(data);

                if (!isBackground) {
                    hideLoading();
                } else {
                    console.log("âœ… ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
                }
            })
            .catch(err => {
                if (!isBackground) {
                    hideLoading();
                }
                console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
                
                // ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬
                if (!isBackground) {
                    // alert("ğŸš¨ ì˜¤ë¥˜ ë°œìƒ ğŸš¨\n\n" + err);
                }
            });
    }

    /**
     * ë©”ì¸ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (ìºì‹œ ìš°ì„ , ì„œë²„ ë°±ê·¸ë¼ìš´ë“œ)
     */
    function fetchData() {
        console.log("ğŸ“± ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘...");
        
        // 1ë‹¨ê³„: ìºì‹œëœ ë°ì´í„° í™•ì¸ ë° ì¦‰ì‹œ í‘œì‹œ
        const cacheLoaded = loadFromCache();
        
        if (cacheLoaded) {
            // ìºì‹œ ë¡œë“œ ì„±ê³µ â†’ ì¦‰ì‹œ í™”ë©´ í‘œì‹œ
            hideLoading();
            
            // 2ë‹¨ê³„: ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì¡°ìš©íˆ)
            setTimeout(() => {
                fetchDataFromServer(true);
            }, 500); // 0.5ì´ˆ í›„ ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸
        } else {
            // ìºì‹œ ì—†ìŒ â†’ ì„œë²„ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
            showLoading();
            fetchDataFromServer(false);
        }
    }

    /**
     * ê°•ì œ ìƒˆë¡œê³ ì¹¨ (ìºì‹œ ë¬´ì‹œ)
     */
    function forceRefresh() {
        console.log("ğŸ”„ ê°•ì œ ìƒˆë¡œê³ ì¹¨...");
        localStorage.removeItem(CACHE_KEY);
        localStorage.removeItem(CACHE_TIME_KEY);
        showLoading();
        fetchDataFromServer(false);
    }

    // ì‚¬ìš©ì ë³€ê²½
    function changeUser() {
        const select = document.getElementById('userSelect');
        if (!select) return;

        currentUser = select.value;

        const inputUser = document.getElementById('inputUser');
        if (inputUser) {
            inputUser.value = currentUser === 'ê°€ì¡±ì „ì²´' ? 'ìœ¤ì„±ì¼' : currentUser;
        }

        // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¬ê³„ì‚°, ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
        if (typeof processData === 'function' && RAW_DATA && RAW_DATA.length > 0) {
            console.log(`ì‚¬ìš©ì ë³€ê²½ë¨: ${currentUser} -> í™”ë©´ ê°±ì‹ `);
            processData(RAW_DATA);
        } else {
            // ìºì‹œì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ë¡œë“œ
            fetchData();
        }
    }

    // íƒ­ ì „í™˜
    function switchTab(tabName) {
        document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        event.currentTarget.classList.add('active');
        if (tabName === 'chart') {
            initChartTab();
        }
    }

    // ============================================
    // í•µì‹¬ ë¡œì§: ë°ì´í„° ê³„ì‚° ë° ì²˜ë¦¬
    // â€» ì´ í•¨ìˆ˜ê°€ ì•±ì˜ í•µì‹¬ì…ë‹ˆë‹¤. ìˆ˜ì • ì‹œ ë§¤ìš° ì£¼ì˜í•˜ì„¸ìš”!
    // ============================================
    
    /**
     * processData()
     * ========================================
     * ê±°ë˜ ë‚´ì—­(logs)ì„ ë¶„ì„í•˜ì—¬ í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ìƒíƒœ ê³„ì‚°
     * ========================================
     * 
     * @param {Array} logs - 2ì°¨ì› ë°°ì—´ í˜•íƒœì˜ ê±°ë˜ ë‚´ì—­
     *   ê° í–‰ êµ¬ì¡°: [ì´ë¦„, ë‚ ì§œ, í‹°ì»¤, ì¢…ëª©ëª…, ìœ í˜•, ìˆ˜ëŸ‰, ë‹¨ê°€, í™˜ìœ¨, ë©”ëª¨]
     * 
     * ì£¼ìš” ê³„ì‚° í•­ëª©:
     * 1. ì¢…ëª©ë³„ ë³´ìœ  ìˆ˜ëŸ‰ ë° í‰ë‹¨ê°€
     * 2. ì˜ˆìˆ˜ê¸ˆ(í˜„ê¸ˆ)ì€ ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ì •í™•í•œ ê°’ì„ ì‚¬ìš© (RAW_DATA.cashInfo)
     * 3. ì£¼ì‹ í‰ê°€ê¸ˆì•¡ (ìˆ˜ëŸ‰ Ã— í˜„ì¬ê°€)
     * 4. í‰ê°€ì†ìµ (í‰ê°€ê¸ˆì•¡ - ì´ë§¤ìˆ˜ì›ê¸ˆ)
     * 5. ì´ì†ìµ = (í˜„ì¬ìì‚° + ì´ì¶œê¸ˆ) - ì´ì…ê¸ˆ
     * 
     * ê±°ë˜ ìœ í˜•ë³„ ì²˜ë¦¬:
     * - ë§¤ìˆ˜: í˜„ê¸ˆâ†“, ìˆ˜ëŸ‰â†‘, ì›ê¸ˆâ†‘
     * - ë§¤ë„: í˜„ê¸ˆâ†‘, ìˆ˜ëŸ‰â†“, ì›ê¸ˆâ†“, ì‹¤í˜„ì†ìµ ê³„ì‚°
     * - ì…ê¸ˆ: í˜„ê¸ˆâ†‘, ì´ì…ê¸ˆâ†‘
     * - ì¶œê¸ˆ: í˜„ê¸ˆâ†“, ì´ì¶œê¸ˆâ†‘
     * - ë°°ë‹¹: í˜„ê¸ˆâ†‘
     * - ì•¡ë©´ë¶„í• : ìˆ˜ëŸ‰ ì¡°ì • (ì›ê¸ˆ ìœ ì§€)
     */
    /**
    /**
     * [ì¬ìˆ˜ì •] ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ (í‰ë‹¨ê°€ ì™œê³¡ í•´ê²° ë° ê°€ì¡± ì „ì²´ í•©ì‚° ë¡œì§ ê°œì„ )
     * - 'ê°€ì¡± ì „ì²´' ì„ íƒ ì‹œ: ê°œë³„ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¨¼ì € ê³„ì‚°í•œ ë’¤, ë‹¨ìˆœ í•©ì‚°í•˜ì—¬ ì™œê³¡ ë°©ì§€
     * - ê°œë³„ ì‚¬ìš©ì ì„ íƒ ì‹œ: í•´ë‹¹ ì‚¬ìš©ìì˜ ê±°ë˜ë‚´ì—­ë§Œìœ¼ë¡œ ê³„ì‚°
     */
    function processData(logs) {
        if (!logs || logs.length === 0) return;

        // 1. ìœ í‹¸ë¦¬í‹° ë° ì´ˆê¸°í™”
        function safeFloat(val) {
            if (val === undefined || val === null || val === '') return 0;
            let str = String(val).replace(/[^\d.-]/g, '');
            let num = Number(str);
            return isNaN(num) ? 0 : num;
        }

        // í˜„ì¬ê°€ Map ë³€í™˜ (â˜… ë³€ê²½: ë°°ì—´ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ì—¬ ì¼ë³€ë™ë¥ , ì „ì¼ì¢…ê°€ë„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œ í•¨)
        let priceMap = {};
        if (typeof CURRENT_PRICES !== 'undefined' && CURRENT_PRICES.length > 0) {
            CURRENT_PRICES.forEach(row => {
                let key = String(row[0]).trim().toUpperCase();
                // row[1] = í˜„ì¬ê°€, row[2] = ì¼ë³€ë™ë¥ , row[3] = ì „ì¼ì¢…ê°€
                if (key) priceMap[key] = row; 
            });
        }

        // â˜… [í•µì‹¬ ë³€ê²½ 1] ëª¨ë“  ì‚¬ìš©ìì˜ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ê°ê° ë”°ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì €ì¥ì†Œ
        let userPortfolios = {}; // { 'ìœ¤ì„±ì¼': { TQQQ: {...}, ... }, 'ìœ¤ì±„í˜„': ... }
        
        let totalDeposit = 0;     
        let totalWithdrawal = 0;
        let userLogs = [];

        // ë‚ ì§œìˆœ ì •ë ¬
        logs.sort((a, b) => new Date(a[1]) - new Date(b[1]));
        
        if (typeof REALIZED_EVENTS !== 'undefined') REALIZED_EVENTS = [];

        // 2. ëª¨ë“  ë¡œê·¸ë¥¼ ìˆœíšŒí•˜ë©° "ê°œë³„ ì‚¬ìš©ì"ë³„ë¡œ í¬íŠ¸í´ë¦¬ì˜¤ ê³„ì‚°
        logs.forEach(row => {
            let name = String(row[0]).trim();
            if (!name) return;

            // ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ ê³µê°„ì´ ì—†ìœ¼ë©´ ìƒì„±
            if (!userPortfolios[name]) userPortfolios[name] = {};

            let date = new Date(row[1]);
            let ticker = String(row[2]).trim().toUpperCase();
            let logName = row[3];
            let type = String(row[4]).trim();
            let qty = safeFloat(row[5]);
            let price = safeFloat(row[6]);
            let fx = safeFloat(row[7]);
            if (fx === 0) fx = 1;

            let amount = price * qty * fx;       
            let amountOrigin = price * qty;      

            // í˜„ì¬ ì„ íƒëœ í™”ë©´ì— ë§ëŠ” ë¡œê·¸ë§Œ userLogsì— ë‹´ê¸° (íˆìŠ¤í† ë¦¬ í‘œì‹œìš©)
            // ê°€ì¡± ì „ì²´ì¼ ê²½ìš° ëª¨ë“  ë¡œê·¸ í¬í•¨, ê°œë³„ ì‚¬ìš©ìì¼ ê²½ìš° í•´ë‹¹ ì‚¬ìš©ìë§Œ í¬í•¨
            let isTargetUser = (currentUser === 'ê°€ì¡± ì „ì²´' || currentUser === 'ê°€ì¡±ì „ì²´' || name === currentUser);
            
            if (isTargetUser) {
                userLogs.push({
                    date: date, ticker: ticker, name: logName, type: type,
                    amount: amount, price: price, qty: qty, userName: name
                });

                if (type === 'ì…ê¸ˆ') totalDeposit += price; 
                else if (type === 'ì¶œê¸ˆ') totalWithdrawal += price;
            }

            // --- í¬íŠ¸í´ë¦¬ì˜¤ ê³„ì‚° (í•´ë‹¹ ì‚¬ìš©ì ê²ƒë§Œ ê±´ë“œë¦¼) ---
            if (!ticker) return;
            
            // í•´ë‹¹ ì‚¬ìš©ìì˜ í•´ë‹¹ ì¢…ëª© ìŠ¬ë¡¯ ê°€ì ¸ì˜¤ê¸°
            if (!userPortfolios[name][ticker]) {
                userPortfolios[name][ticker] = { 
                    qty: 0, totalCost: 0, totalAmtOrigin: 0, name: logName,
                    splitMemory: null 
                };
            }
            let item = userPortfolios[name][ticker];

            if (type === 'ë§¤ìˆ˜') {
                item.qty += qty; 
                item.totalCost += amount; 
                item.totalAmtOrigin += amountOrigin;
            } else if (type === 'ë§¤ë„') {
                let avgCost = item.qty > 0 ? (item.totalCost / item.qty) : 0;
                let costBasis = avgCost * qty;
                let avgCostOrigin = item.qty > 0 ? (item.totalAmtOrigin / item.qty) : 0;
                let costBasisOrigin = avgCostOrigin * qty;
                
                let profit = amount - costBasis;

                // ì‹¤í˜„ì†ìµ ì´ë²¤íŠ¸ ê¸°ë¡ (í™”ë©´ì— í‘œì‹œí•  ëŒ€ìƒë§Œ)
                if (isTargetUser && typeof REALIZED_EVENTS !== 'undefined') {
                    REALIZED_EVENTS.push({
                        date: date, name: logName || ticker, ticker: ticker, 
                        profit: profit, returnRate: costBasis === 0 ? 0 : (profit / costBasis) * 100,
                        who: name
                    });
                }

                item.qty -= qty; 
                item.totalCost -= costBasis; 
                item.totalAmtOrigin -= costBasisOrigin;
                
                if (item.qty <= 0.000001) delete userPortfolios[name][ticker];

            } else if (type === 'ì•¡ë©´ë¶„í• ì…ê³ ') {
                if (item.splitMemory) {
                    item.totalCost = item.splitMemory.cost; 
                    item.totalAmtOrigin = item.splitMemory.origin;
                    item.splitMemory = null;
                } else { 
                    item.totalCost += amount; item.totalAmtOrigin += amountOrigin; 
                }
                item.qty += qty;
            } else if (type === 'ì•¡ë©´ë¶„í• ì¶œê³ ') {
                item.splitMemory = { cost: item.totalCost, origin: item.totalAmtOrigin };
                item.qty = 0; item.totalCost = 0; item.totalAmtOrigin = 0;
            }
        });

        // 3. â˜… [í•µì‹¬ ë³€ê²½ 2] í™”ë©´ì— í‘œì‹œí•  ìµœì¢… í¬íŠ¸í´ë¦¬ì˜¤ í•©ì‚° (Aggregation)
        let finalPortfolio = {}; 
        
        // í•©ì‚° ëŒ€ìƒ ìœ ì € ì„ ì •
        let targetUsers = [];
        if (currentUser === 'ê°€ì¡± ì „ì²´' || currentUser === 'ê°€ì¡±ì „ì²´') {
            targetUsers = Object.keys(userPortfolios); // ëª¨ë“  ì‚¬ìš©ì
        } else {
            targetUsers = [currentUser]; // í˜„ì¬ ì„ íƒëœ ì‚¬ìš©ìë§Œ
        }

        targetUsers.forEach(uName => {
            let uPort = userPortfolios[uName];
            if (!uPort) return;

            for (let t in uPort) {
                let uItem = uPort[t];
                
                if (!finalPortfolio[t]) {
                    finalPortfolio[t] = { 
                        qty: 0, totalCost: 0, totalAmtOrigin: 0, name: uItem.name 
                    };
                }
                
                // ë‹¨ìˆœ í•©ì‚° (ë¬¼ë¦¬ì  ê²°í•©) -> í‰ë‹¨ê°€ ì™œê³¡ ë°©ì§€
                finalPortfolio[t].qty += uItem.qty;
                finalPortfolio[t].totalCost += uItem.totalCost;      // ì´ ë§¤ìˆ˜ ê¸ˆì•¡(ì›í™”í™˜ì‚°) í•©ì‚°
                finalPortfolio[t].totalAmtOrigin += uItem.totalAmtOrigin; // ì´ ë§¤ìˆ˜ ê¸ˆì•¡(ì›í™”) í•©ì‚°
            }
        });

        // 4. ë³´ìœ  ì£¼ì‹ í‰ê°€ ë° ë¦¬ìŠ¤íŠ¸ ìƒì„±
        let stockValuation = 0;
        let balanceList = [];
        let totalTodayProfitKRW = 0; // â˜… ì¶”ê°€: ì˜¤ëŠ˜ ì „ì²´ ì†ìµ í•©ì‚° ë³€ìˆ˜

        for (let t in finalPortfolio) {
            let item = finalPortfolio[t];
            let fetchedPriceRow = priceMap[t] || priceMap["KRX:" + t];
            
            // â˜… ì¶”ê°€: í˜„ì¬ê°€, ì¼ë³€ë™ë¥ , ì „ì¼ì¢…ê°€ íŒŒì‹±
            let rawCurrentPrice = fetchedPriceRow && !isNaN(fetchedPriceRow[1]) ? Number(fetchedPriceRow[1]) : (item.qty > 0 ? (item.totalAmtOrigin / item.qty) : 0);
            let changePct = fetchedPriceRow && !isNaN(fetchedPriceRow[2]) ? Number(fetchedPriceRow[2]) : 0;
            let yesterdayPrice = fetchedPriceRow && !isNaN(fetchedPriceRow[3]) ? Number(fetchedPriceRow[3]) : rawCurrentPrice;
            
            // í‰ë‹¨ê°€ëŠ” í•©ì‚°ëœ ë°ì´í„°ì—ì„œ ì—­ì‚° (ì´íˆ¬ì…ê¸ˆì•¡ / ì´ìˆ˜ëŸ‰)
            let avgPrice = item.qty > 0 ? (item.totalAmtOrigin / item.qty) : 0;
            
            let isKorea = !isNaN(t.charAt(0)); 
            let displayName = isKorea ? item.name : t;

            // í™˜ìœ¨ ì ìš©ëœ ì›í™” í‰ê°€ì•¡ ê³„ì‚°
            let finalPrice = rawCurrentPrice;
            let finalYesterdayPrice = yesterdayPrice;
            let fx = isKorea ? 1 : (typeof CURRENT_EXCHANGE_RATE !== 'undefined' ? CURRENT_EXCHANGE_RATE : 1);
            
            if (!isKorea) {
                finalPrice = rawCurrentPrice * fx;
                finalYesterdayPrice = yesterdayPrice * fx;
            }

            let evalAmount = item.qty * finalPrice;
            stockValuation += evalAmount;
            
            let pnl = evalAmount - item.totalCost;
            let rate = item.totalCost === 0 ? 0 : (pnl / item.totalCost) * 100;

            // â˜… ì¶”ê°€: í•´ë‹¹ ì¢…ëª©ì˜ ì˜¤ëŠ˜ ì†ìµ(ì›í™”) ê³„ì‚°
            let todayProfitAmt = item.qty * Math.round(finalPrice - finalYesterdayPrice);
            totalTodayProfitKRW += todayProfitAmt; // ì „ì²´ ì˜¤ëŠ˜ ì†ìµì— ëˆ„ì 

            balanceList.push({
                name: displayName, ticker: t, qty: item.qty,
                avgPrice: avgPrice, curPrice: rawCurrentPrice,
                evalAmt: evalAmount, profit: pnl, rate: rate, isKorea: isKorea,
                // â˜… ì¶”ê°€: ìì‹ ì»´í¬ë„ŒíŠ¸(render í•¨ìˆ˜)ì—ì„œ ì‚¬ìš©í•  ë³€ë™ ë°ì´í„°
                changePct: changePct, todayProfitAmt: todayProfitAmt 
            });
        }

        // 5. í˜„ê¸ˆ ë° ì´ìì‚° ê³„ì‚° (GASì—ì„œ ë°›ì•„ì˜¨ cashInfo ì‚¬ìš©)
        let myCashKRW = 0;
        let myCashUSD = 0;
        
        if (typeof LAST_FETCHED_DATA !== 'undefined' && LAST_FETCHED_DATA && LAST_FETCHED_DATA.cashInfo) {
            const cInfo = LAST_FETCHED_DATA.cashInfo;
            // í‚¤ ê³µë°± ì œê±° ë§¤ì¹­ í•¨ìˆ˜
            const findData = (key) => {
                if (!key) return null;
                const clean = key.replace(/\s/g, '');
                const found = Object.keys(cInfo).find(k => k.replace(/\s/g, '') === clean);
                return found ? cInfo[found] : null;
            };

            let userData = findData(currentUser);
            if (userData) {
                myCashKRW = userData.cashKRW || 0;
                myCashUSD = userData.cashUSD || 0;
            }
        }

        let totalCashValuation = myCashKRW + (myCashUSD * (typeof CURRENT_EXCHANGE_RATE !== 'undefined' ? CURRENT_EXCHANGE_RATE : 1));
        let totalAsset = totalCashValuation + stockValuation;
        
        // ìµœì¢… ìˆ˜ìµ ê³„ì‚° (ì´ìì‚° + ì´ì¶œê¸ˆ - ì´ì…ê¸ˆ)
        // ì£¼ì˜: ê°€ì¡± ì „ì²´ì¼ ë•Œ totalDeposit/Withdrawalì€ ìœ„ loopì—ì„œ í•©ì‚°ë¨
        let finalProfit = (totalAsset + totalWithdrawal) - totalDeposit;
        let finalRate = totalDeposit === 0 ? 0 : (finalProfit / totalDeposit) * 100;

        // 6. DOM ì—…ë°ì´íŠ¸
        const elAsset = document.getElementById('totalAsset');
        if (elAsset) elAsset.innerText = Math.round(totalAsset).toLocaleString() + "ì›";

        const elProfit = document.getElementById('totalProfit');
        if (elProfit) {
            elProfit.innerText = `${Math.round(finalProfit).toLocaleString()}ì› (${finalRate.toFixed(1)}%)`;
            elProfit.className = finalProfit >= 0 ? 'up' : 'down';
        }

        // â˜… [í•µì‹¬ ì¶”ê°€] ì˜¤ëŠ˜ ì†ìµ ìš”ì•½ DOM ì—…ë°ì´íŠ¸
        const elTodayProfit = document.getElementById('todayProfit');
        if (elTodayProfit) {
            let yesterdayTotalAsset = totalAsset - totalTodayProfitKRW;
            let todayTotalPct = yesterdayTotalAsset !== 0 ? (totalTodayProfitKRW / yesterdayTotalAsset) * 100 : 0;
            
            let tSign = totalTodayProfitKRW > 0 ? "+" : "";
            let tIcon = totalTodayProfitKRW > 0 ? "â¬†ï¸" : (totalTodayProfitKRW < 0 ? "ğŸ“‰" : "");
            let tColor = totalTodayProfitKRW > 0 ? "up" : (totalTodayProfitKRW < 0 ? "down" : "");
            
            elTodayProfit.className = tColor;
            elTodayProfit.innerHTML = `${tSign}${Math.round(totalTodayProfitKRW).toLocaleString()}ì› (${tSign}${todayTotalPct.toFixed(2)}%) ${tIcon}`;
        }

        const elCash = document.getElementById('cashHoldings');
        if (elCash) elCash.innerText = Math.round(totalCashValuation).toLocaleString() + "ì›";

        const elStock = document.getElementById('stockHoldings');
        if (elStock) elStock.innerText = Math.round(stockValuation).toLocaleString() + "ì›";

        // 7. ì°¨íŠ¸/í…Œì´ë¸” ë Œë”ë§
        let chartDataLabels = [...balanceList.map(b => b.name), 'ì˜ˆìˆ˜ê¸ˆ'];
        let chartDataValues = [...balanceList.map(b => b.evalAmt), totalCashValuation];

        if(typeof renderDonutChart === 'function') renderDonutChart(chartDataLabels, chartDataValues, totalCashValuation, totalAsset);
        // â˜… balanceListì— changePctì™€ todayProfitAmtê°€ ë‹´ê²¨ì„œ ë„˜ì–´ê°‘ë‹ˆë‹¤!
        if(typeof renderStockList === 'function') renderStockList(balanceList);
        if(typeof renderHistory === 'function') renderHistory(userLogs.slice().reverse().slice(0, 20));
        
        if(typeof renderBalanceTable === 'function') {
            renderBalanceTable(balanceList, totalAsset, totalCashValuation, myCashKRW, myCashUSD);
        }
        
        if(typeof renderPerformanceTable === 'function') renderPerformanceTable();

        if (typeof renderPerformanceChartFromSheet === 'function' && typeof PERFORMANCE_DATA !== 'undefined') {
            let myPerfLogs;
            // ë„ì–´ì“°ê¸° ìœ ì—°í•˜ê²Œ ì²˜ë¦¬
            if (currentUser === 'ê°€ì¡± ì „ì²´' || currentUser === 'ê°€ì¡±ì „ì²´') {
                myPerfLogs = []; 
            } else {
                myPerfLogs = PERFORMANCE_DATA.filter(row => row[1] === currentUser);
            }
            renderPerformanceChartFromSheet(myPerfLogs, MARKET_DATA);
        }
    }

    // ë„ë„› ì°¨íŠ¸ ë Œë”ë§ (ì˜ˆìˆ˜ê¸ˆ í¬í•¨) - ë°ì´í„° ë¼ë²¨ ì¶”ê°€
    function renderDonutChart(labels, values, cash, totalAsset) {
        const ctx = document.getElementById('donutChart');
        if (!ctx) return;

        if (myDonutChart) myDonutChart.destroy();

        if (values.length === 0 || values.every(v => v === 0)) {
            ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
            return;
        }

        myDonutChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#FF3B30', '#FF9500', '#FFCC00', '#34C759', 
                        '#007AFF', '#5856D6', '#AF52DE', '#FF2D55',
                        '#999999'  // ì˜ˆìˆ˜ê¸ˆ ìƒ‰ìƒ (íšŒìƒ‰)
                    ],
                    borderWidth: 0
                }]
            },
            // â˜… [í•µì‹¬ ì¶”ê°€] chartjs-plugin-datalabels í™œì„±í™”
            plugins: [ChartDataLabels], 
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 10,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = Math.round(context.parsed);
                                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                let percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${label}: ${value.toLocaleString()}ì› (${percentage}%)`;
                            }
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 12
                        },
                        formatter: function(value, context) {
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = ((value / total) * 100).toFixed(1);
                            // ë¹„ì¤‘ì´ 5% ë¯¸ë§Œì´ë©´ ë¼ë²¨ í‘œì‹œ ì•ˆí•¨ (ì°¨íŠ¸ê°€ ê¹”ë”í•´ì§)
                            if (percentage < 5) return '';
                            return percentage + '%';
                        }
                    }
                }
            }
        });
    }

    // ë³´ìœ  ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderStockList(balanceList) {
        const listDiv = document.getElementById('stockList');
        if (!listDiv) return;

        listDiv.innerHTML = '';

        if (balanceList.length === 0) {
            listDiv.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        balanceList.forEach(item => {
            // ê¸°ì¡´ ì´ ìˆ˜ìµ ìƒ‰ìƒ
            let colorClass = item.profit >= 0 ? 'up' : 'down';
            
            // â˜… [ì¶”ê°€] ì˜¤ëŠ˜ ë³€ë™ í‘œì‹œìš© ë³€ìˆ˜ (ë¶€í˜¸, ì•„ì´ì½˜, ìƒ‰ìƒ í´ë˜ìŠ¤)
            let tSign = item.todayProfitAmt > 0 ? "+" : "";
            let tIcon = item.todayProfitAmt > 0 ? "ğŸ”¥" : (item.todayProfitAmt < 0 ? "ğŸ“‰" : "");
            let tColorClass = item.todayProfitAmt > 0 ? "up" : (item.todayProfitAmt < 0 ? "down" : "");

            let itemDiv = document.createElement('div');
            itemDiv.className = 'stock-item';
            
            itemDiv.innerHTML = `
                <div>
                    <div class="stock-name">${item.name}</div>
                    <div class="stock-ticker">${item.ticker}</div>
                </div>
                <div style="text-align: right;">
                    <div class="stock-price" style="color: #333;">${Math.round(item.evalAmt).toLocaleString()}ì›</div>
                    <div class="stock-change ${colorClass}">${item.rate.toFixed(1)}% (${Math.round(item.profit).toLocaleString()}ì›)</div>
                    <div class="${tColorClass}" style="font-size: 12px; margin-top: 3px; font-weight: 500;">
                        ì˜¤ëŠ˜ ${tSign}${Math.round(item.todayProfitAmt).toLocaleString()}ì› (${tSign}${item.changePct.toFixed(2)}%) ${tIcon}
                    </div>
                </div>
            `;
            
            listDiv.appendChild(itemDiv);
        });
    }

    // ì”ê³  í…Œì´ë¸” ë Œë”ë§ (ì˜ˆìˆ˜ê¸ˆ í¬í•¨í•œ ë¹„ì¤‘ ê³„ì‚°)
    function renderBalanceTable(items, totalAsset, cash) {
        const tbody = document.querySelector('#balanceTable tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        items.forEach(item => {
            // ìˆ˜ì •: ì˜ˆìˆ˜ê¸ˆ í¬í•¨í•œ ì´ìì‚° ê¸°ì¤€ìœ¼ë¡œ ë¹„ì¤‘ ê³„ì‚°
            let weight = totalAsset > 0 ? (item.evalAmt / totalAsset) * 100 : 0;
            let color = item.profit >= 0 ? 'up' : 'down';
            
            // â˜… [ì¶”ê°€] ì˜¤ëŠ˜ ë³€ë™ í‘œì‹œìš© ë³€ìˆ˜
            let tSign = item.changePct > 0 ? "+" : "";
            let tIcon = item.changePct > 0 ? "ğŸ”¥" : (item.changePct < 0 ? "ğŸ“‰" : "");
            let tColorClass = item.changePct > 0 ? "up" : (item.changePct < 0 ? "down" : "");

            let displayAvgPrice = "";
            let displayCurPrice = "";

            if (item.isKorea) {
                displayAvgPrice = Math.round(item.avgPrice).toLocaleString() + "ì›";
                displayCurPrice = Math.round(item.curPrice).toLocaleString() + "ì›";
            } else {
                displayAvgPrice = `<span style="color:#008000">$${Number(item.avgPrice).toFixed(2)}</span>`;
                displayCurPrice = `<span style="color:#008000">$${Number(item.curPrice).toFixed(2)}</span>`;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.name}</td>
                <td class="${color}">${Math.round(item.profit).toLocaleString()}</td>
                <td class="${color}">${item.rate.toFixed(1)}%</td>
                <td class="${tColorClass}" style="font-weight: bold;">${tSign}${item.changePct.toFixed(2)}% ${tIcon}</td>
                <td>${item.qty}</td>
                <td>${displayAvgPrice}</td>
                <td>${displayCurPrice}</td>
                <td>${Math.round(item.evalAmt).toLocaleString()}</td>
                <td>${weight.toFixed(1)}%</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ë‚ ì§œ íŒŒì‹± ìœ í‹¸ë¦¬í‹°
    function safeParseDate(val) {
        if (!val) return new Date();
        
        let d = new Date(val);
        if (!isNaN(d.getTime())) return d;

        if (typeof val === 'string') {
            let cleanStr = val.replace(/['"]/g, '').replace(/\./g, '-').trim();
            d = new Date(cleanStr);
            if (!isNaN(d.getTime())) return d;
        }
        return new Date();
    }

    function getDateNum(dateVal) {
        const d = safeParseDate(dateVal);
        const y = d.getFullYear();
        const m = d.getMonth() + 1;
        const day = d.getDate();
        return y * 10000 + m * 100 + day;
    }

    // ê±°ë˜ë‚´ì—­ ë Œë”ë§ (í™˜ìœ¨ ë°˜ì˜ ë° ì´ì•¡/ë‹¨ê°€ UI ê°œì„ )
    function renderHistory(customData = null) {
        const listDiv = document.getElementById('historyList');
        if (!listDiv) return;

        listDiv.innerHTML = '';

        let dataToRender;
        
        // customDataê°€ ì—†ìœ¼ë©´ RAW_DATAì—ì„œ í˜„ì¬ ì‚¬ìš©ì ê²ƒë§Œ í•„í„°ë§
        if (customData === null) {
            dataToRender = RAW_DATA.filter(r => r[0] === currentUser)
                                   .sort((a, b) => new Date(a[1]) - new Date(b[1]))
                                   .slice(-20)  // ìµœì‹  20ê°œ
                                   .reverse();  // ìµœì‹ ìˆœìœ¼ë¡œ
        } else {
            dataToRender = customData.slice().reverse();
        }

        if (!dataToRender || dataToRender.length === 0) {
            listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        dataToRender.forEach(row => {
            // ë°ì´í„° ê²€ì¦
            if (!row || row.length < 7) return;
            
            let dateRaw = safeParseDate(row[1]);
            
            let dateStr = dateRaw.getFullYear().toString().slice(2) + '.' + 
                          (dateRaw.getMonth()+1).toString().padStart(2,'0') + '.' + 
                          dateRaw.getDate().toString().padStart(2,'0');
            
            let ticker = row[2] || '';
            let name = row[3] || '';
            let type = row[4] || '';
            let qty = Number(row[5]) || 0;
            let rawPrice = Number(row[6]) || 0; // ë‹¨ê°€ ë˜ëŠ” ë°°ë‹¹/ì…ì¶œê¸ˆì•¡
            let fx = Number(row[7]) || 0;       // Hì—´ì— ê¸°ë¡ëœ í™˜ìœ¨

            let isUS = false;
            // í‹°ì»¤ê°€ ë¯¸êµ­ ì£¼ì‹ì´ê±°ë‚˜, í‹°ì»¤ê°€ ì—†ì–´ë„ í™˜ìœ¨ì´ ì í˜€ìˆìœ¼ë©´ ë¯¸êµ­ ê±°ë˜ë¡œ ê°„ì£¼
            if (ticker && !/^\d{6}$/.test(ticker)) isUS = true;
            else if (!ticker && fx > 100) isUS = true;

            // í™˜ìœ¨ ë³´ì • (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— í™˜ìœ¨ì´ ëˆ„ë½ë˜ì—ˆì„ ê²½ìš° í˜„ì¬ í™˜ìœ¨ ì ìš©)
            if (isUS && fx < 100) {
                fx = (typeof CURRENT_EXCHANGE_RATE !== 'undefined') ? CURRENT_EXCHANGE_RATE : 1450;
            } else if (!isUS) {
                fx = 1;
            }

            // â˜… [í•µì‹¬ ë³€ê²½] ì´ ê±°ë˜ ê¸ˆì•¡(ì›í™” í™˜ì‚°) ê³„ì‚°
            let totalAmountKRW = 0;
            if (type === 'ë§¤ìˆ˜' || type === 'ë§¤ë„') {
                totalAmountKRW = rawPrice * qty * fx; // ìˆ˜ëŸ‰ x ë‹¨ê°€ x í™˜ìœ¨
            } else {
                totalAmountKRW = rawPrice * fx;       // ì…ì¶œê¸ˆ, ë°°ë‹¹ ë“± (ìˆ˜ëŸ‰ì´ ì—†ëŠ” ê²½ìš°)
            }

            let badgeColor = '#999';
            if (type === 'ë§¤ìˆ˜') badgeColor = 'var(--up)';
            else if (type === 'ë§¤ë„') badgeColor = 'var(--down)';
            else if (type === 'ë°°ë‹¹') badgeColor = '#2ECC71';
            else if (type === 'ì…ê¸ˆ' || type === 'ì¶œê¸ˆ') badgeColor = '#95a5a6';

            // í™”ë©´ì— ë³´ì—¬ì¤„ í…ìŠ¤íŠ¸ í¬ë§·íŒ…
            let priceStr = Math.round(totalAmountKRW).toLocaleString();
            let qtyStr = qty > 0 ? `${qty}ì£¼` : '';
            let subPriceInfo = '';

            // ì„œë¸Œ í…ìŠ¤íŠ¸ (ë‹¬ëŸ¬ ë‹¨ê°€ ë˜ëŠ” ì›í™” ë‹¨ê°€ í‘œì‹œ)
            if (isUS) {
                if (type === 'ë§¤ìˆ˜' || type === 'ë§¤ë„') {
                    subPriceInfo = `<span style="font-size:11px; color:#aaa; margin-left:4px;">($${rawPrice} / í™˜ìœ¨ ${Math.round(fx)}ì›)</span>`;
                } else {
                    subPriceInfo = `<span style="font-size:11px; color:#aaa; margin-left:4px;">($${rawPrice})</span>`;
                }
            } else {
                if ((type === 'ë§¤ìˆ˜' || type === 'ë§¤ë„') && qty > 0) {
                     subPriceInfo = `<span style="font-size:11px; color:#aaa; margin-left:4px;">(${rawPrice.toLocaleString()}ì›)</span>`;
                }
            }

            let descHtml = '';
            if(type === 'ì…ê¸ˆ' || type === 'ì¶œê¸ˆ') {
                descHtml = `
                    <div class="stock-price" style="font-weight:bold; font-size:15px;">${priceStr}ì›</div>
                    ${isUS ? `<div style="font-size:11px; color:#aaa; margin-top:2px;">($${rawPrice} / í™˜ìœ¨ ${Math.round(fx)}ì›)</div>` : ''}
                `;
            } else if (type === 'ë°°ë‹¹') {
                descHtml = `
                    <div class="stock-price" style="font-weight:bold; color:#2ECC71; font-size:15px;">+${priceStr}ì›</div>
                    <div style="font-size:11px; color:#aaa; margin-top:2px;">(ë°°ë‹¹ê¸ˆ) ${isUS ? `$${rawPrice}` : ''}</div>
                `;
            } else {
                descHtml = `
                    <div class="stock-price" style="font-weight:bold; font-size:15px;">${priceStr}ì›</div>
                    <div class="stock-change" style="color:#666; font-size:12px; margin-top:2px;">
                        ${qtyStr} ${subPriceInfo}
                    </div>
                `;
            }

            let itemDiv = document.createElement('div');
            itemDiv.className = 'stock-item';
            itemDiv.style.display = 'flex';
            itemDiv.style.justifyContent = 'space-between';
            itemDiv.style.alignItems = 'center';
            itemDiv.style.padding = '12px 0';
            itemDiv.style.borderBottom = '1px solid #eee';
            
            itemDiv.innerHTML = `
                <div style="display:flex; align-items:center; flex: 1; min-width: 0; margin-right: 10px;">
                    <div style="margin-right:12px; color:#999; font-size:12px; min-width:55px;">${dateStr}</div>
                    
                    <div style="flex: 1; min-width: 0; display:flex; align-items:center;">
                        <div style="
                            font-weight:bold; 
                            font-size:15px; 
                            white-space: nowrap; 
                            overflow: hidden; 
                            text-overflow: ellipsis; 
                            max-width: 100%; 
                        ">
                            <span class="badge" style="
                                display: inline-block;
                                vertical-align: middle;
                                margin-right:6px; 
                                font-size:11px; 
                                padding:3px 6px; 
                                border-radius:4px; 
                                color:white; 
                                background:${badgeColor};
                            ">${type}</span>
                            <span style="vertical-align: middle;">${name}</span>
                        </div>
                        ${ticker ? `<span style="font-size:12px; color:#888; margin-left:4px; white-space:nowrap;">(${ticker})</span>` : ''}
                    </div>
                </div>
                
                <div style="text-align:right; flex-shrink: 0;">
                    ${descHtml}
                </div>
            `;
            listDiv.appendChild(itemDiv);
        });
    }

    // ê±°ë˜ë‚´ì—­ í•„í„°ë§
    function filterHistory() {
        const startEl = document.getElementById('startDate');
        const endEl = document.getElementById('endDate');
    
        const startVal = startEl.value;
        const endVal = endEl.value;

        if (!startVal || !endVal) {
            alert("ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const startNum = parseInt(startVal.replace(/-/g, ''));
        const endNum = parseInt(endVal.replace(/-/g, ''));

        const filtered = RAW_DATA.filter(row => {
            if (row[0] !== currentUser) return false;

            let d = new Date(row[1]);
            if (isNaN(d)) return false;

            let y = d.getFullYear();
            let m = String(d.getMonth() + 1).padStart(2, '0');
            let day = String(d.getDate()).padStart(2, '0');
            let rowNum = parseInt(`${y}${m}${day}`);

            return rowNum >= startNum && rowNum <= endNum;
        });

        if (filtered.length === 0) {
            alert("í•´ë‹¹ ê¸°ê°„ì˜ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        renderHistory(filtered);
    }

    // ê±°ë˜ë‚´ì—­ ì´ˆê¸°í™”
    function resetHistory() {
        const startEl = document.getElementById('startDate');
        const endEl = document.getElementById('endDate');
        
        if (startEl) startEl.value = '';
        if (endEl) endEl.value = '';

        let myLogs = RAW_DATA.filter(r => r[0] === currentUser);
        myLogs.sort((a, b) => new Date(a[1]) - new Date(b[1]));
        let recent20 = myLogs.slice(-20);
        renderHistory(recent20);
    }

    // ì—°ë„ë³„ ì†ìµ ê³„ì‚°
    function calculateYearlyProfit(perfData) {
        let yearlyStats = {};

        perfData.forEach(row => {
            let date = safeParseDate(row[0]);
            let year = date.getFullYear();
            let flow = Number(row[2]);
            let asset = Number(row[3]);

            if (!yearlyStats[year]) {
                yearlyStats[year] = {
                    lastAsset: 0,
                    totalFlow: 0
                };
            }
            yearlyStats[year].lastAsset = asset;
            yearlyStats[year].totalFlow += flow;
        });

        let years = Object.keys(yearlyStats).sort();
        let prevYearAsset = 0;

        let result = years.map(year => {
            let stat = yearlyStats[year];
            let profit = stat.lastAsset - prevYearAsset - stat.totalFlow;
            prevYearAsset = stat.lastAsset;

            let investAmt = stat.totalFlow + prevYearAsset;
            let roi = (investAmt !== 0) ? (profit / investAmt * 100) : 0;

            return {
                year: year,
                profit: profit,
                roi: roi
            };
        });

        return result;
    }

    // ì„±ê³¼ í…Œì´ë¸” ë Œë”ë§
    function renderPerformanceTable() {
        const listDiv = document.getElementById('realizedProfitList');
        if (!listDiv) return;
        
        listDiv.innerHTML = '';

        REALIZED_EVENTS = [];
        let realizedMap = {};
        let portfolio = {};
        
        let totalDeposit = 0;
        let totalWithdraw = 0;

        let myLogs = RAW_DATA.filter(r => r[0] === currentUser);
        myLogs.sort((a, b) => new Date(a[1]) - new Date(b[1]));

        myLogs.forEach(row => {
            let dateStr = row[1];
            let date = new Date(dateStr);
            if (isNaN(date)) return;

            let year = date.getFullYear();
            let ticker = String(row[2]).trim();
            let name = String(row[3]).trim();
            let type = String(row[4]).trim();
            let qty = Number(row[5]);
            let price = Number(row[6]);
            let fx = row[7] ? Number(row[7]) : 1;
            
            let calcQty = qty;
            if (type === 'ë°°ë‹¹' && qty === 0) {
                calcQty = 1;
            }

            let amount = price * calcQty * fx;

            if (type === 'ì…ê¸ˆ') {
                totalDeposit += Number(row[6]);
            } else if (type === 'ì¶œê¸ˆ') {
                totalWithdraw += Number(row[6]);
            }

            if (type === 'ë§¤ìˆ˜') {
                if (!portfolio[ticker]) portfolio[ticker] = { qty: 0, totalCost: 0 };
                portfolio[ticker].qty += qty;
                portfolio[ticker].totalCost += amount;
            } 
            else if (type === 'ë§¤ë„') {
                if (portfolio[ticker] && portfolio[ticker].qty > 0) {
                    let avgCost = portfolio[ticker].totalCost / portfolio[ticker].qty;
                    let costBasis = avgCost * qty;
                    let profit = amount - costBasis;
                    
                    if (!realizedMap[year]) realizedMap[year] = 0;
                    realizedMap[year] += profit;

                    REALIZED_EVENTS.push({
                        date: date,
                        name: name || ticker,
                        ticker: ticker,
                        type: 'ë§¤ë„',
                        profit: profit,
                        returnRate: costBasis === 0 ? 0 : (profit / costBasis) * 100
                    });

                    portfolio[ticker].qty -= qty;
                    portfolio[ticker].totalCost -= costBasis;
                    if (portfolio[ticker].qty <= 0.000001) delete portfolio[ticker];
                }
            }
            else if (type === 'ë°°ë‹¹') {
                if (!realizedMap[year]) realizedMap[year] = 0;
                realizedMap[year] += amount;
                
                REALIZED_EVENTS.push({
                    date: date,
                    name: (name || ticker) + "(ë°°ë‹¹)",
                    ticker: ticker,
                    type: 'ë°°ë‹¹',
                    profit: amount,
                    returnRate: 100
                });
            }
            else if (type === 'ì•¡ë©´ë¶„í• ì¶œê³ ') {
                if (portfolio[ticker]) {
                    portfolio[ticker].qty -= qty;
                }
            }
            else if (type === 'ì•¡ë©´ë¶„í• ì…ê³ ') {
                if (!portfolio[ticker]) {
                    portfolio[ticker] = { qty: 0, totalCost: 0 };
                }
                portfolio[ticker].qty += qty;
            }
        });

        const myPerfData = PERFORMANCE_DATA.filter(row => row[1] === currentUser);
        const yearlyResults = typeof calculateYearlyProfit === 'function' 
                              ? calculateYearlyProfit(myPerfData) 
                              : [];

        let currentTotalAsset = 0;
        if (myPerfData.length > 0) {
            myPerfData.sort((a, b) => new Date(b[0]) - new Date(a[0]));
            currentTotalAsset = Number(myPerfData[0][3]);
        }
        
        let grandTotalProfit = (currentTotalAsset + totalWithdraw) - totalDeposit;
        let grandRealizedProfit = Object.values(realizedMap).reduce((a, b) => a + b, 0);

        if (yearlyResults.length === 0 && Object.keys(realizedMap).length === 0 && grandTotalProfit === 0) {
            listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        let yearSet = new Set();
        yearlyResults.forEach(y => yearSet.add(Number(y.year)));
        Object.keys(realizedMap).forEach(y => yearSet.add(Number(y)));
        let displayYears = Array.from(yearSet).sort((a, b) => b - a);

        const color = (val) => val >= 0 ? 'up' : 'down';
        const fmt = (n) => Math.round(n).toLocaleString();

        let rowsHtml = '';
        displayYears.forEach(year => {
            let totalData = yearlyResults.find(r => Number(r.year) === year);
            let totalProfit = totalData ? totalData.profit : 0;
            let realized = realizedMap[year] || 0;

            rowsHtml += `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:12px 8px; text-align:center;">${year}</td>
                    <td style="padding:12px 8px; text-align:right;" class="${color(totalProfit)}">${fmt(totalProfit)}</td>
                    <td style="padding:12px 8px; text-align:right; font-weight:bold; color:#333;">${fmt(realized)}</td>
                </tr>
            `;
        });

        let tableHtml = `
            <div style="overflow-x:auto; margin-bottom:20px; border:1px solid #eee; border-radius:8px;">
                <table style="width:100%; font-size:13px; border-collapse: collapse;">
                    <thead>
                        <tr style="background:#f8f9fa; border-bottom:2px solid #ddd; color:#555;">
                            <th style="padding:10px; text-align:center;">ê¸°ê°„</th>
                            <th style="padding:10px; text-align:right;">ì´ì†ìµ</th>
                            <th style="padding:10px; text-align:right;">ì‹¤í˜„ì†ìµ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background:#e8f4ff; border-bottom:2px solid #ccc; font-weight:bold;">
                            <td style="padding:12px 8px; text-align:center;">ì „ì²´</td>
                            <td style="padding:12px 8px; text-align:right;" class="${color(grandTotalProfit)}">${fmt(grandTotalProfit)}</td>
                            <td style="padding:12px 8px; text-align:right; color:#333;">${fmt(grandRealizedProfit)}</td>
                        </tr>
                        ${rowsHtml}
                    </tbody>
                </table>
            </div>
        `;
        
        tableHtml += `<div id="detailContainer"></div>`;
        listDiv.innerHTML = tableHtml;

        const yearSelect = document.getElementById('yearSelect');
        if (yearSelect) {
            let currentSelect = yearSelect.value;
            yearSelect.innerHTML = '';
            
            let allOpt = document.createElement('option');
            allOpt.value = 'all';
            allOpt.text = 'ì „ì²´ ë‚´ì—­';
            yearSelect.add(allOpt);

            displayYears.forEach(y => {
                let opt = document.createElement('option');
                opt.value = y;
                opt.text = y + 'ë…„ ìƒì„¸';
                if(Number(y) == Number(currentSelect)) opt.selected = true;
                yearSelect.add(opt);
            });
            
            if (!currentSelect && displayYears.length > 0) {
                yearSelect.value = displayYears[0];
            }
        }

        if (typeof renderRealizedDetail === 'function') {
            renderRealizedDetail();
        }
    }

    // ì‹¤í˜„ì†ìµ ìƒì„¸
    function renderRealizedDetail() {
        const container = document.getElementById('detailContainer');
        const yearSelect = document.getElementById('yearSelect');
        
        if (!container || !yearSelect) return;

        container.innerHTML = '';
        const selectedValue = yearSelect.value;

        const headerTitle = selectedValue === 'all' ? "ì „ì²´ ë§¤ë„ ìƒì„¸ ë‚´ì—­" : `${selectedValue}ë…„ ë§¤ë„ ìƒì„¸ ë‚´ì—­`;
        
        const detailDiv = document.createElement('div');
        detailDiv.innerHTML = `
            <div style="margin-top:20px; font-weight:bold; font-size:14px; margin-bottom:10px; border-bottom:2px solid #333; padding-bottom:5px; color:#333;">
                ğŸ“„ ${headerTitle}
            </div>`;
        container.appendChild(detailDiv);

        const filteredEvents = REALIZED_EVENTS.filter(item => {
            if (item.type !== 'ë§¤ë„') return false;
            if (selectedValue === 'all') return true;
            return item.date.getFullYear() == selectedValue;
        });

        filteredEvents.sort((a, b) => b.date - a.date);

        if(filteredEvents.length === 0) {
            let emptyDiv = document.createElement('div');
            emptyDiv.innerHTML = `<div style="text-align:center; padding:30px; color:#999; font-size:13px;">ë§¤ë„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            container.appendChild(emptyDiv);
            return;
        }

        filteredEvents.forEach(item => {
            let isProfit = item.profit >= 0;
            let profitColor = isProfit ? '#ff3b30' : '#007aff';
            let profitSign = isProfit ? '+' : '';
            let dateStr = item.date.toISOString().slice(0, 10);
            
            let rateDisplay = `<span style="font-size:12px; color:${profitColor};">${item.returnRate.toFixed(1)}%</span>`;

            let itemDiv = document.createElement('div');
            itemDiv.className = 'stock-item';
            
            itemDiv.innerHTML = `
                <div style="
                    width: 100%;
                    box-sizing: border-box;
                    display: flex; 
                    justify-content: space-between; 
                    align-items: center; 
                    padding: 12px 4px; 
                    border-bottom: 1px solid #f0f0f0;
                ">
                    <div style="text-align:left; flex: 1;">
                        <div style="font-weight:bold; font-size:14px; color:#333; margin-bottom:3px;">
                            ${item.name}
                        </div>
                        <div style="font-size:12px; color:#999;">
                            ${dateStr}
                        </div>
                    </div>

                    <div style="text-align:right; flex-shrink: 0;">
                        <div style="font-weight:bold; font-size:14px; color:${profitColor}; margin-bottom:3px;">
                            ${profitSign}${Math.round(item.profit).toLocaleString()}
                        </div>
                        <div>
                            ${rateDisplay}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(itemDiv);
        });
    }

    // ì„±ê³¼ ì°¨íŠ¸
    function renderPerformanceChartFromSheet(perfLogs, benchmarks) {
        const ctx = document.getElementById('lineChart');
        if (!ctx) return;
        
        const context = ctx.getContext('2d');
        if(myLineChart) myLineChart.destroy();

        if(benchmarks.length === 0 || perfLogs.length === 0) return;

        let labels = [];
        let dataMy = [];
        let dataK = [], dataS = [], dataN = [];

        const startDate = new Date(perfLogs[0][0]);
        let startIdx = benchmarks.findIndex(b => new Date(b.date) >= startDate);
        if(startIdx === -1) startIdx = 0;
        
        const baseK = benchmarks[startIdx].kospi || 1;
        const baseS = benchmarks[startIdx].sp500 || 1;
        const baseN = benchmarks[startIdx].nasdaq || 1;

        let myMap = {};
        perfLogs.forEach(log => {
            let d = new Date(log[0]).toISOString().split('T')[0];
            myMap[d] = Number(log[8]) * 100;
        });

        for(let i = startIdx; i < benchmarks.length; i++) {
            let b = benchmarks[i];
            let dateKey = b.date.substring(0, 10);
            
            labels.push(dateKey);
            
            dataK.push(((b.kospi - baseK) / baseK) * 100);
            dataS.push(((b.sp500 - baseS) / baseS) * 100);
            dataN.push(((b.nasdaq - baseN) / baseN) * 100);

            if (myMap.hasOwnProperty(dateKey)) {
                dataMy.push(myMap[dateKey]);
            } else {
                dataMy.push(null);
            }
        }

        myLineChart = new Chart(context, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'ğŸ† ë‚´ ìˆ˜ìµë¥ ',
                        data: dataMy,
                        borderColor: '#FF3B30',
                        backgroundColor: '#FF3B30',
                        borderWidth: 3,
                        pointRadius: 0,
                        spanGaps: true,
                        tension: 0.1,
                        fill: false
                    },
                    { 
                        label: 'S&P500', 
                        data: dataS, 
                        borderColor: '#36A2EB', 
                        backgroundColor: '#36A2EB',
                        borderWidth: 1, 
                        pointRadius: 0,
                        fill: false 
                    },
                    { 
                        label: 'NASDAQ', 
                        data: dataN, 
                        borderColor: '#9966FF', 
                        backgroundColor: '#9966FF',
                        borderWidth: 1, 
                        pointRadius: 0,
                        fill: false 
                    },
                    { 
                        label: 'KOSPI', 
                        data: dataK, 
                        borderColor: '#FF9F40', 
                        backgroundColor: '#FF9F40',
                        borderWidth: 1, 
                        pointRadius: 0,
                        fill: false 
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { display: false },
                    y: { 
                        grid: { color: '#f0f0f0' }, 
                        ticks: { callback: v => v + '%' } 
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            usePointStyle: false,
                            boxWidth: 12
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    },
                    datalabels: {
                        display: false  // ë¼ì¸ ì°¨íŠ¸ì—ëŠ” ë¼ë²¨ í‘œì‹œ ì•ˆí•¨
                    }
                }
            }
        });
    }

    // ê±°ë˜ ì €ì¥
    function submitTransaction() {
        const btn = document.querySelector('button.btn-primary');
        btn.innerText = "ì €ì¥ ì¤‘...";
        btn.disabled = true;

        const data = {
            authKey: currentAuthKey,
            who: document.getElementById('inputUser').value,
            date: document.getElementById('inputDate').value,
            ticker: document.getElementById('inputTicker').value,
            name: document.getElementById('inputName').value,
            type: document.getElementById('inputType').value,
            qty: document.getElementById('inputQty').value,
            price: document.getElementById('inputPrice').value,
            fxRate: document.getElementById('inputFx').value || (document.getElementById('inputTicker').value ? '' : 1),
            memo: document.getElementById('inputMemo').value
        };

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(() => {
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ë°ì´í„° ë°˜ì˜ê¹Œì§€ ì ì‹œ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
            // ìºì‹œ ì‚­ì œ í›„ ìƒˆë¡œê³ ì¹¨
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_TIME_KEY);
            location.reload();
        }).catch(err => {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + err);
            btn.innerText = "ê±°ë˜ ì €ì¥";
            btn.disabled = false;
        });
    }

    // ============================================
    // [ìˆ˜ì •ë¨] ì˜ˆìˆ˜ê¸ˆ ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
    // ============================================
    
    /**
     * openCashEditModal()
     * - ëª¨ë‹¬ì„ ì—´ ë•Œ, 'ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ í˜„ì¬ ì”ê³ 'ë¥¼ ì…ë ¥ì¹¸ì— ë¯¸ë¦¬ ì±„ì›Œì¤ë‹ˆë‹¤.
     * - ì‚¬ìš©ìëŠ” í˜„ì¬ ì¸ì‹ëœ ì”ê³ ë¥¼ ë³´ê³ , ì‹¤ì œ ì”ê³ ë¡œ ìˆ˜ì •í•˜ë©´ ë©ë‹ˆë‹¤.
     */
    function openCashEditModal() {
        const modal = document.getElementById('cashEditModal');
        const krwInput = document.getElementById('edit-krw');
        const usdInput = document.getElementById('edit-usd');
        
        // ì„œë²„ ë°ì´í„°(RAW_DATA)ì—ì„œ í˜„ì¬ ë‚´ ì”ê³  ê°€ì ¸ì˜¤ê¸°
        let currentKRW = 0;
        let currentUSD = 0;

        if (typeof RAW_DATA !== 'undefined' && RAW_DATA.cashInfo && RAW_DATA.cashInfo[currentUser]) {
            currentKRW = RAW_DATA.cashInfo[currentUser].cashKRW || 0;
            currentUSD = RAW_DATA.cashInfo[currentUser].cashUSD || 0;
        }

        // ì…ë ¥ì¹¸ì— í˜„ì¬ ê°’ ì±„ì›Œë„£ê¸° (ìˆ˜ì •í•˜ê¸° í¸í•˜ë„ë¡)
        krwInput.value = Math.round(currentKRW); 
        usdInput.value = currentUSD; 
        
        modal.style.display = 'block';
    }

    /**
     * closeCashEditModal()
     * - ëª¨ë‹¬ ë‹«ê¸°
     */
    function closeCashEditModal() {
        const modal = document.getElementById('cashEditModal');
        modal.style.display = 'none';
    }

    /**
     * saveCashEdit()
     * - ì…ë ¥í•œ ì‹¤ì œ ì”ê³ ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•˜ì—¬ ë³´ì •
     * âš ï¸ [ìˆ˜ì •] WEB_APP_URL â†’ GOOGLE_SCRIPT_URLë¡œ ë³€ê²½
     */
    function saveCashEdit() {
        const krwInput = document.getElementById('edit-krw'); 
        const usdInput = document.getElementById('edit-usd');
        
        // ì…ë ¥ê°’ì´ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬
        const realKRW = parseFloat(krwInput.value) || 0;
        const realUSD = parseFloat(usdInput.value) || 0;
        
        // ìœ íš¨ì„± ê²€ì‚¬
        if (realKRW === 0 && realUSD === 0) {
            if(!confirm("ì›í™”ì™€ ë‹¬ëŸ¬ ì”ê³ ë¥¼ ëª¨ë‘ 0ì›ìœ¼ë¡œ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        }
        
        // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
        const btnSave = document.querySelector('.btn-save');
        if(btnSave) {
            btnSave.disabled = true;
            btnSave.innerText = "ì €ì¥ ì¤‘...";
        }

        // ì„œë²„ ì „ì†¡ìš© ë°ì´í„°
        const payload = {
            authKey: currentAuthKey,
            type: "adjustCash",     // ë°±ì—”ë“œ ì•½ì†ëœ íƒ€ì…
            who: currentUser,
            actualKRW: realKRW,
            actualUSD: realUSD
        };

        console.log("ì˜ˆìˆ˜ê¸ˆ ìˆ˜ì • ìš”ì²­:", payload);

        // Google Apps Scriptë¡œ ì „ì†¡ (ìˆ˜ì •ëœ URL ì‚¬ìš©)
        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(() => {
            // no-cors ëª¨ë“œì—ì„œëŠ” ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
            alert("ì˜ˆìˆ˜ê¸ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
            closeCashEditModal();
            // ìºì‹œ ì‚­ì œ í›„ ìƒˆë¡œê³ ì¹¨
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_TIME_KEY);
            location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        })
        .catch(err => {
            console.error("ì„œë²„ í†µì‹  ì‹¤íŒ¨:", err);
            alert("ì„œë²„ í†µì‹  ì‹¤íŒ¨: " + err.message);
        })
        .finally(() => {
            if(btnSave) {
                btnSave.disabled = false;
                btnSave.innerText = "ì €ì¥";
            }
        });
    }

    // ============================================
    // ì°¨íŠ¸ íƒ­ â€” ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸ ê¸°ëŠ¥
    // ============================================

    let myCandleChart = null;
    let chartAllData = [];          // ì „ì²´ OHLC ë°°ì—´ (ë‚ ì§œìˆœ)
    let chartTradeData = [];        // ë§¤ìˆ˜/ë§¤ë„ ë‚´ì—­
    let chartAvgPrice = 0;          // í‰ê· ë§¤ì…ê°€
    let chartCurrentTicker = null;  // í˜„ì¬ í‹°ì»¤
    let chartTickerMeta = [];       // ì¢…ëª© ëª©ë¡ { ticker, name, avgPrice, trades }
    let chartTabInited = false;     // ì¢…ëª© ë²„íŠ¼ ìµœì´ˆ ë Œë” ì—¬ë¶€

    // â”€â”€ ì°¨íŠ¸ íƒ­ ì§„ì… ì‹œ í˜¸ì¶œ
    function initChartTab() {
        if (chartTabInited && chartTickerMeta.length > 0) return;
        buildTickerButtons();
    }

    // â”€â”€ RAW_DATAì—ì„œ ë³´ìœ  ì¢…ëª© + ê±°ë˜ë‚´ì—­ ì¶”ì¶œ
    function buildTickerButtons() {
        const btnList = document.getElementById('tickerBtnList');
        if (!btnList) return;

        // í˜„ì¬ê°€ ì‹œíŠ¸ ë°ì´í„°(CURRENT_PRICES)ì—ì„œ í‹°ì»¤ ëª©ë¡ ì¶”ì¶œ
        let tickers = [];
        if (typeof CURRENT_PRICES !== 'undefined' && CURRENT_PRICES.length > 0) {
            CURRENT_PRICES.forEach(row => {
                let t = String(row[0]).trim().toUpperCase();
                if (t) tickers.push(t);
            });
        }

        if (tickers.length === 0) {
            btnList.innerHTML = '<span style="color:var(--text-sub);font-size:13px;">ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
            return;
        }

        // í‹°ì»¤ë³„ ê±°ë˜ë‚´ì—­ & í‰ê· ë§¤ì…ê°€ ê³„ì‚°
        chartTickerMeta = tickers.map(ticker => {
            let trades = [];
            let portfolio = { qty: 0, totalCost: 0 };
            let myLogs = RAW_DATA.filter(r => String(r[2]).trim().toUpperCase() === ticker);
            myLogs.sort((a, b) => new Date(a[1]) - new Date(b[1]));

            myLogs.forEach(row => {
                let type = String(row[4]).trim();
                let qty = Number(row[5]) || 0;
                let price = Number(row[6]) || 0;
                let fx = Number(row[7]) || 1;
                if (fx === 0) fx = 1;

                if (type === 'ë§¤ìˆ˜') {
                    portfolio.qty += qty;
                    portfolio.totalCost += qty * price;
                    trades.push({ date: row[1], type: 'ë§¤ìˆ˜', qty, price });
                } else if (type === 'ë§¤ë„') {
                    let costBasisPerShare = portfolio.qty > 0 ? portfolio.totalCost / portfolio.qty : 0;
                    portfolio.qty -= qty;
                    portfolio.totalCost -= costBasisPerShare * qty;
                    if (portfolio.qty < 0.000001) { portfolio.qty = 0; portfolio.totalCost = 0; }
                    trades.push({ date: row[1], type: 'ë§¤ë„', qty, price });
                }
            });

            let avgPrice = portfolio.qty > 0 ? portfolio.totalCost / portfolio.qty : 0;
            // ì¢…ëª©ëª… ì°¾ê¸°
            let nameRow = RAW_DATA.find(r => String(r[2]).trim().toUpperCase() === ticker && r[3]);
            let name = nameRow ? String(nameRow[3]).trim() : ticker;

            return { ticker, name, avgPrice, trades };
        });

        // ë²„íŠ¼ ë Œë”ë§
        btnList.innerHTML = '';
        chartTickerMeta.forEach((meta, idx) => {
            let btn = document.createElement('button');
            btn.className = 'ticker-btn' + (idx === 0 ? ' active' : '');
            btn.textContent = meta.ticker;
            btn.onclick = () => selectTicker(meta.ticker, btn);
            btnList.appendChild(btn);
        });

        chartTabInited = true;

        // ì²« ë²ˆì§¸ ì¢…ëª© ìë™ ë¡œë“œ
        if (chartTickerMeta.length > 0) {
            selectTicker(chartTickerMeta[0].ticker, btnList.querySelector('.ticker-btn'));
        }
    }

    // â”€â”€ ì¢…ëª© ì„ íƒ
    function selectTicker(ticker, btnEl) {
        document.querySelectorAll('.ticker-btn').forEach(b => b.classList.remove('active'));
        if (btnEl) btnEl.classList.add('active');

        chartCurrentTicker = ticker;
        let meta = chartTickerMeta.find(m => m.ticker === ticker);
        if (!meta) return;

        chartTradeData = meta.trades;
        chartAvgPrice = meta.avgPrice;

        // ì •ë³´ ë°” ì—…ë°ì´íŠ¸
        const labelEl = document.getElementById('chartTickerLabel');
        const badgeEl = document.getElementById('avgPriceBadge');
        if (labelEl) labelEl.textContent = `${meta.name} (${ticker})`;
        if (badgeEl) {
            let isKorea = /^\d{6}$/.test(ticker);
            if (chartAvgPrice > 0) {
                badgeEl.textContent = `í‰ê· ë§¤ì…ê°€ ${isKorea ? Math.round(chartAvgPrice).toLocaleString() + 'ì›' : '$' + chartAvgPrice.toFixed(2)}`;
                badgeEl.style.display = 'inline-block';
            } else {
                badgeEl.style.display = 'none';
            }
        }

        loadCandleData(ticker);
    }

    // â”€â”€ ì•±ìŠ¤ìŠ¤í¬ë¦½íŠ¸ì—ì„œ OHLC ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function loadCandleData(ticker) {
        document.getElementById('candleChartCard').style.display = 'none';
        document.getElementById('chartLoadingMsg').style.display = 'block';

        const url = `${GOOGLE_SCRIPT_URL}?authKey=${currentAuthKey}&action=getChartData&ticker=${encodeURIComponent(ticker)}`;

        fetch(url)
            .then(res => res.text())
            .then(text => {
                // HTML ì‘ë‹µ(ì—ëŸ¬) ì²˜ë¦¬
                if (text.trim().startsWith('<')) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                return JSON.parse(text);
            })
            .then(data => {
                document.getElementById('chartLoadingMsg').style.display = 'none';

                if (data.error || !data.dates || data.dates.length === 0) {
                    document.getElementById('candleChartCard').style.display = 'block';
                    showCandleEmpty();
                    return;
                }

                // OHLC ë°°ì—´ ì¡°ë¦½ (ë‚ ì§œëŠ” UTC ê¸°ì¤€ìœ¼ë¡œ íŒŒì‹±í•´ì„œ timezone ì˜¤ë¥˜ ë°©ì§€)
                chartAllData = data.dates.map((d, i) => {
                    // "2021-08-10" í˜•ì‹ì„ UTCë¡œ íŒŒì‹±
                    let ts = new Date(d + 'T00:00:00Z').getTime();
                    return {
                        x: ts,
                        o: Number(data.opens[i]) || 0,
                        h: Number(data.highs[i]) || 0,
                        l: Number(data.lows[i]) || 0,
                        c: Number(data.closes[i]) || 0
                    };
                }).filter(d => !isNaN(d.x) && d.h > 0);

                console.log('ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', chartAllData.length, 'ê°œ ìº”ë“¤, ì²«ë²ˆì§¸:', chartAllData[0]);

                document.getElementById('candleChartCard').style.display = 'block';
                setPeriod(6); // ê¸°ë³¸ 6ê°œì›”
            })
            .catch(err => {
                document.getElementById('chartLoadingMsg').style.display = 'none';
                document.getElementById('candleChartCard').style.display = 'block';
                console.error('ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
                showCandleEmpty();
            });
    }

    function showCandleEmpty() {
        const canvas = document.getElementById('candleChart');
        if (!canvas) return;
        const dpr = window.devicePixelRatio || 1;
        canvas.width  = canvas.offsetWidth * dpr;
        canvas.height = canvas.offsetHeight * dpr;
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);
        ctx.fillStyle = '#999';
        ctx.font = '13px -apple-system, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', canvas.offsetWidth / 2, canvas.offsetHeight / 2);
    }

    // â”€â”€ ê¸°ê°„ ë²„íŠ¼ í´ë¦­
    function setPeriod(months) {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        let periodMap = { 1:'1ê°œì›”', 3:'3ê°œì›”', 6:'6ê°œì›”', 12:'1ë…„', 0:'ì „ì²´' };
        document.querySelectorAll('.period-btn').forEach(b => {
            if (b.textContent === (periodMap[months] || '')) b.classList.add('active');
        });

        if (!chartAllData || chartAllData.length === 0) return;

        let endTs = chartAllData[chartAllData.length - 1].x;
        let startTs;
        if (months === 0) {
            startTs = chartAllData[0].x;
        } else {
            let d = new Date(endTs);
            d.setMonth(d.getMonth() - months);
            startTs = d.getTime();
            // ë°ì´í„° ì‹œì‘ë³´ë‹¤ ì•ì´ë©´ í´ë¨í”„
            if (startTs < chartAllData[0].x) startTs = chartAllData[0].x;
        }

        renderCandleChart(startTs, endTs);
    }

    // â”€â”€ ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸ ë Œë”ë§
    // â”€â”€ Canvas ê¸°ë°˜ ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let candleViewMin = 0;  // í˜„ì¬ ë·° ì‹œì‘ timestamp
    let candleViewMax = 0;  // í˜„ì¬ ë·° ë timestamp
    let candleW_fixed = 0;  // canvas ê³ ì • í¬ê¸°
    let candleH_fixed = 0;

    function renderCandleChart(startTime, endTime) {
        candleViewMin = startTime;
        candleViewMax = endTime;

        const canvas = document.getElementById('candleChart');
        if (!canvas) return;

        // í¬ê¸°ë¥¼ í•œ ë²ˆë§Œ ì¡ê¸° - offsetWidthê°€ 0ì´ë©´ ë¶€ëª¨ì—ì„œ ê°€ì ¸ì˜¤ê¸°
        const wrap = canvas.parentElement;
        const W = wrap ? wrap.offsetWidth : (window.innerWidth - 32);
        const H = 340;
        const dpr = window.devicePixelRatio || 1;

        // canvas í¬ê¸° ê³ ì • (ì´í›„ drawCandlesì—ì„œëŠ” ì¬ì„¤ì • ì•ˆ í•¨)
        canvas.style.width  = W + 'px';
        canvas.style.height = H + 'px';
        canvas.width  = W * dpr;
        canvas.height = H * dpr;
        candleW_fixed = W;
        candleH_fixed = H;

        drawCandles();
        attachCandleTouchEvents();
    }

    function drawCandles() {
        const canvas = document.getElementById('candleChart');
        if (!canvas || !chartAllData || chartAllData.length === 0) return;

        const dpr = window.devicePixelRatio || 1;
        // í¬ê¸° ì¬ì„¤ì • ì—†ì´ ê³ ì •ê°’ ì‚¬ìš©
        const W = candleW_fixed || canvas.offsetWidth;
        const H = candleH_fixed || canvas.offsetHeight;
        if (W === 0 || H === 0) return;

        // canvas ë‚´ìš©ë§Œ ì§€ìš°ê¸° (í¬ê¸° ë³€ê²½ ì—†ì´)
        const ctx = canvas.getContext('2d');
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        const isDark = document.body.classList.contains('dark-mode');
        const upColor   = '#FF3B30';
        const downColor = '#007AFF';
        const gridColor = isDark ? 'rgba(255,255,255,0.07)' : 'rgba(0,0,0,0.06)';
        const textColor = isDark ? '#888' : '#999';
        const bgColor   = isDark ? '#1C1C1E' : '#fff';

        // ìº”ë²„ìŠ¤ ë°°ê²½
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, W, H);

        const PAD_L = 8, PAD_R = 58, PAD_T = 12, PAD_B = 28;
        const chartW = W - PAD_L - PAD_R;
        const chartH = H - PAD_T - PAD_B;

        // ë·° ë²”ìœ„ ë‚´ ë°ì´í„° í•„í„°
        const visible = chartAllData.filter(d => d.x >= candleViewMin && d.x <= candleViewMax);
        if (visible.length === 0) return;

        // Y ë²”ìœ„
        let yMin = Math.min(...visible.map(d => d.l));
        let yMax = Math.max(...visible.map(d => d.h));
        if (chartAvgPrice > 0) {
            yMin = Math.min(yMin, chartAvgPrice * 0.99);
            yMax = Math.max(yMax, chartAvgPrice * 1.01);
        }
        const yPad = (yMax - yMin) * 0.05 || yMin * 0.02;
        yMin -= yPad; yMax += yPad;
        const yRange = yMax - yMin;

        function toX(ts) { return PAD_L + (ts - candleViewMin) / (candleViewMax - candleViewMin) * chartW; }
        function toY(v)  { return PAD_T + (1 - (v - yMin) / yRange) * chartH; }

        const isKorea = /^\d{6}$/.test(chartCurrentTicker);
        function fmtPrice(v) {
            return isKorea ? Math.round(v).toLocaleString() + 'ì›' : '$' + Number(v).toFixed(2);
        }

        // ê·¸ë¦¬ë“œ ë¼ì¸ (Y)
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;
        const yTicks = 5;
        for (let i = 0; i <= yTicks; i++) {
            const v = yMin + (yRange / yTicks) * i;
            const y = toY(v);
            ctx.beginPath(); ctx.moveTo(PAD_L, y); ctx.lineTo(W - PAD_R, y); ctx.stroke();
            ctx.fillStyle = textColor;
            ctx.font = `10px -apple-system, sans-serif`;
            ctx.textAlign = 'left';
            ctx.fillText(fmtPrice(v), W - PAD_R + 4, y + 4);
        }

        // Xì¶• ë‚ ì§œ ë ˆì´ë¸”
        const xTicks = Math.min(5, visible.length);
        ctx.fillStyle = textColor;
        ctx.font = '10px -apple-system, sans-serif';
        ctx.textAlign = 'center';
        for (let i = 0; i < xTicks; i++) {
            const idx = Math.round(i / (xTicks - 1) * (visible.length - 1));
            const d = new Date(visible[idx].x);
            const label = (d.getMonth()+1).toString().padStart(2,'0') + '/' + d.getDate().toString().padStart(2,'0');
            ctx.fillText(label, toX(visible[idx].x), H - 6);
        }

        // ìº”ë“¤ í­ ê³„ì‚°
        const candleW = Math.max(1, Math.min(12, (chartW / visible.length) * 0.7));

        // ìº”ë“¤ ê·¸ë¦¬ê¸°
        visible.forEach(d => {
            const x = toX(d.x);
            const isUp = d.c >= d.o;
            ctx.strokeStyle = isUp ? upColor : downColor;
            ctx.fillStyle   = isUp ? upColor : downColor;
            ctx.lineWidth = 1;

            // ì‹¬ì§€
            ctx.beginPath();
            ctx.moveTo(x, toY(d.h));
            ctx.lineTo(x, toY(d.l));
            ctx.stroke();

            // ëª¸í†µ
            const bodyTop = toY(Math.max(d.o, d.c));
            const bodyBot = toY(Math.min(d.o, d.c));
            const bodyH   = Math.max(1, bodyBot - bodyTop);
            ctx.fillRect(x - candleW/2, bodyTop, candleW, bodyH);
        });

        // í‰ê· ë§¤ì…ê°€ ë¼ì¸
        if (chartAvgPrice > 0) {
            const avgY = toY(chartAvgPrice);
            ctx.strokeStyle = 'rgba(0,180,255,0.9)';
            ctx.lineWidth = 1.5;
            ctx.setLineDash([5, 4]);
            ctx.beginPath();
            ctx.moveTo(PAD_L, avgY);
            ctx.lineTo(W - PAD_R, avgY);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // ë§¤ìˆ˜/ë§¤ë„ ë§ˆì»¤ (í•´ë‹¹ ë‚ ì§œ ìº”ë“¤ì— B/S ë±ƒì§€ë¡œ í‘œì‹œ)
        chartTradeData.forEach(trade => {
            const ts = new Date(trade.date + 'T00:00:00Z').getTime();
            if (ts < candleViewMin || ts > candleViewMax) return;
            const nearest = visible.reduce((p, c) => Math.abs(c.x - ts) < Math.abs(p.x - ts) ? c : p, visible[0]);
            if (!nearest) return;
            const x = toX(nearest.x);
            const isBuy = trade.type === 'ë§¤ìˆ˜';
            const bgColor2 = isBuy ? '#34C759' : '#FF3B30';
            const label = isBuy ? 'B' : 'S';
            const r = Math.max(9, candleW * 1.2); // ë±ƒì§€ ë°˜ì§€ë¦„ (ìº”ë“¤ í­ì— ë¹„ë¡€)

            // ë±ƒì§€ ìœ„ì¹˜: ë§¤ìˆ˜ëŠ” ì €ê°€ ì•„ë˜, ë§¤ë„ëŠ” ê³ ê°€ ìœ„
            const badgeY = isBuy ? toY(nearest.l) + r + 4 : toY(nearest.h) - r - 4;

            // ì„  (ìº”ë“¤ ì‹¬ì§€ì—ì„œ ë±ƒì§€ê¹Œì§€)
            ctx.strokeStyle = bgColor2;
            ctx.lineWidth = 1;
            ctx.setLineDash([2, 2]);
            ctx.beginPath();
            ctx.moveTo(x, isBuy ? toY(nearest.l) : toY(nearest.h));
            ctx.lineTo(x, badgeY + (isBuy ? -r : r));
            ctx.stroke();
            ctx.setLineDash([]);

            // ì›í˜• ë±ƒì§€
            ctx.fillStyle = bgColor2;
            ctx.beginPath();
            ctx.arc(x, badgeY, r, 0, Math.PI * 2);
            ctx.fill();

            // B / S í…ìŠ¤íŠ¸
            ctx.fillStyle = '#fff';
            ctx.font = `bold ${Math.max(9, r)}px -apple-system, sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(label, x, badgeY);
            ctx.textBaseline = 'alphabetic';
        });
    }

    // â”€â”€ í„°ì¹˜ ì¸í„°ë™ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function attachCandleTouchEvents() {
        const canvas = document.getElementById('candleChart');
        if (!canvas) return;
        // ì´ë¯¸ ë“±ë¡ëœ ê²½ìš° ì¤‘ë³µ ë°©ì§€
        if (canvas._touchBound) return;
        canvas._touchBound = true;

        let isDragging = false, isPinching = false;
        let lastTouchX = 0;
        let pinchStartDist = 0, pinchStartMin = 0, pinchStartMax = 0;

        function pinchDist(t) {
            const dx = t[0].clientX - t[1].clientX;
            const dy = t[0].clientY - t[1].clientY;
            return Math.sqrt(dx*dx + dy*dy);
        }
        function clamp(min, max) {
            const dataMin = chartAllData[0].x;
            const dataMax = chartAllData[chartAllData.length-1].x;
            const minSpan = 10 * 86400000;
            let span = max - min;
            if (span < minSpan) { const c = (min+max)/2; min=c-minSpan/2; max=c+minSpan/2; }
            if (min < dataMin) { max += dataMin-min; min = dataMin; }
            if (max > dataMax) { min -= max-dataMax; max = dataMax; }
            return { min: Math.max(min,dataMin), max: Math.min(max,dataMax) };
        }
        function applyRange(min, max) {
            const r = clamp(min, max);
            candleViewMin = r.min; candleViewMax = r.max;
            drawCandles();
        }

        canvas.addEventListener('touchstart', e => {
            if (e.touches.length === 1) {
                isDragging = true; isPinching = false;
                lastTouchX = e.touches[0].clientX;
            } else if (e.touches.length === 2) {
                isDragging = false; isPinching = true;
                pinchStartDist = pinchDist(e.touches);
                pinchStartMin = candleViewMin; pinchStartMax = candleViewMax;
            }
        }, { passive: true });

        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            if (isDragging && e.touches.length === 1) {
                const dx = e.touches[0].clientX - lastTouchX;
                lastTouchX = e.touches[0].clientX;
                const span = candleViewMax - candleViewMin;
                const delta = -(dx / canvas.offsetWidth) * span;
                applyRange(candleViewMin + delta, candleViewMax + delta);
            } else if (isPinching && e.touches.length === 2) {
                const ratio = pinchStartDist / pinchDist(e.touches);
                const center = (pinchStartMin + pinchStartMax) / 2;
                const half = (pinchStartMax - pinchStartMin) / 2 * ratio;
                applyRange(center - half, center + half);
            }
        }, { passive: false });

        canvas.addEventListener('touchend', () => { isDragging = false; isPinching = false; });
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const modal = document.getElementById('cashEditModal');
        if (event.target === modal) {
            closeCashEditModal();
        }
    }

</script>

</body>
</html>
