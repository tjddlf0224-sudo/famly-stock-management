<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- ============================================
         ë©”íƒ€ ì •ë³´ ë° ì™¸ë¶€ ë¦¬ì†ŒìŠ¤
         ============================================ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Stock Manager</title>
    
    <!-- PWA ì„¤ì • (ëª¨ë°”ì¼ ì•±ì²˜ëŸ¼ ì‚¬ìš© ê°€ëŠ¥) -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" href="./icon-192.png">
    
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬: ë„ë„›/ë¼ì¸ ì°¨íŠ¸ ê·¸ë¦¬ê¸°ìš© -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ============================================
           CSS ë³€ìˆ˜ ì •ì˜ (ì „ì—­ ìƒ‰ìƒ í…Œë§ˆ)
           - ì—¬ê¸°ì„œ ìƒ‰ìƒì„ ë³€ê²½í•˜ë©´ ì „ì²´ ì•± ìƒ‰ìƒì´ ë°”ë€ë‹ˆë‹¤
           ============================================ */
        :root {
            --primary: #007AFF;      /* ë©”ì¸ íŒŒë€ìƒ‰ (ë²„íŠ¼, í™œì„± íƒ­) */
            --bg: #F2F4F8;          /* ë°°ê²½ìƒ‰ (ì—°í•œ íšŒìƒ‰) */
            --card-bg: #FFFFFF;     /* ì¹´ë“œ ë°°ê²½ìƒ‰ (í°ìƒ‰) */
            --text-main: #333;      /* ì£¼ í…ìŠ¤íŠ¸ (ì§„í•œ íšŒìƒ‰) */
            --text-sub: #666;       /* ë³´ì¡° í…ìŠ¤íŠ¸ (ì¤‘ê°„ íšŒìƒ‰) */
            --up: #FF3B30;          /* ìƒìŠ¹/ìˆ˜ìµ (ë¹¨ê°•) */
            --down: #007AFF;        /* í•˜ë½/ì†ì‹¤ (íŒŒë‘) */
            --nav-height: 60px;     /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë†’ì´ */
        }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text-main); padding-bottom: var(--nav-height); -webkit-tap-highlight-color: transparent; }
        
        /* í—¤ë” */
        header { 
            background: var(--card-bg); 
            padding: 15px 20px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 1px 5px rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            gap: 10px;
        }
        
        h1 { 
            margin: 0; 
            font-size: 18px; 
            font-weight: 700; 
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        select#userSelect { 
            padding: 5px 10px; 
            border-radius: 15px; 
            border: 1px solid #ddd; 
            font-size: 14px; 
            background: #fff; 
            outline: none;
            flex-shrink: 1;
            max-width: 60%;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; display: none; }
        .container.active { display: block; }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .card h3 { margin: 0 0 15px 0; font-size: 16px; color: var(--text-sub); }
        
        /* í…ìŠ¤íŠ¸ ìœ í‹¸ */
        .big-text { font-size: 28px; font-weight: 800; margin: 5px 0; }
        .sub-text { font-size: 14px; color: var(--text-sub); }
        .up { color: var(--up); }
        .down { color: var(--down); }
        .flex-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .divider { border-top: 1px solid #eee; margin: 15px 0; }

        /* ë„ë„› ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .chart-container { position: relative; height: 250px; width: 100%; }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .stock-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .stock-item:last-child { border-bottom: none; }
        .stock-name { font-weight: 600; font-size: 15px; }
        .stock-ticker { font-size: 12px; color: #888; margin-top: 2px; }
        .stock-price { font-weight: 600; text-align: right; }
        .stock-change { font-size: 12px; text-align: right; margin-top: 2px; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-wrap { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
       th, td { padding: 10px; text-align: right; border-bottom: 1px solid #eee; }
    
        /* âœ… ê¶Œì¥: ìŠ¤í¬ë¡¤ ì‹œ í—¤ë” ê³ ì • */
        th { 
            text-align: center; 
            background: #f9f9f9; 
            font-weight: 600; 
            color: #555;
            position: sticky;
            top: 0;
            z-index: 10;
        } 
        td:first-child { text-align: left; font-weight: 600; background: var(--card-bg); }
    
        /* ê±°ë˜ë‚´ì—­ í¼ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #666; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button.btn-primary { width: 100%; background: var(--primary); color: white; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        button.btn-primary:active { opacity: 0.9; }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); height: var(--nav-height); border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-item { flex: 1; text-align: center; font-size: 11px; color: #999; cursor: pointer; padding: 8px 0; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 3px; }

        /* ë¡œë”© í™”ë©´ */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ê±°ë˜ë‚´ì—­ í•„í„° ì˜ì—­ */
        .history-filter {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            align-items: center;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
        }
        .history-filter input {
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
            font-size: 13px;
            width: 110px;
        }
        .history-filter button {
            background: #333;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        /* ìœ í˜•ë³„ ì»¬ëŸ¬ ë°°ì§€ */
        .badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 6px;
            color: white;
            min-width: 30px;
            text-align: center;
        }
        .badge.buy { background-color: #ff3b30; }
        .badge.sell { background-color: #007aff; }
        .badge.deposit { background-color: #ff9500; }
        .badge.withdraw { background-color: #5856d6; }
        .badge.div { background-color: #ffcc00; color: #333; }
        
        .ticker-text {
            font-size: 12px;
            color: #888;
            margin-left: 4px;
            font-weight: normal;
        }

        /* ì˜ˆìˆ˜ê¸ˆ ìˆ˜ì • ë²„íŠ¼ */
        .edit-cash-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
        }
        .edit-cash-btn:active {
            opacity: 0.8;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: var(--card-bg);
            margin: 15% auto;
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #666;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-cancel, .btn-save {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-cancel {
            background: #ddd;
            color: #333;
        }
        .btn-save {
            background: var(--primary);
            color: white;
        }
        .btn-save:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div id="loginModal" style="
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 9999;
    display: flex; justify-content: center; align-items: center;
    backdrop-filter: blur(5px);
">
    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; width: 80%; max-width: 300px;">
        <h3>ğŸ”’ ê°€ì¡± ë¡œê·¸ì¸</h3>
        <p style="font-size: 14px; color: #666; margin-bottom: 20px;">ê°€ì¡± ì•”í˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        <input type="password" id="inputPass" placeholder="ì•”í˜¸ ì…ë ¥" 
            style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">
        <button onclick="tryLogin()" 
            style="width: 100%; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px;">
            í™•ì¸
        </button>
    </div>
</div>

<div id="loader">
    <div class="spinner"></div>
    <div id="loadingText">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<header>
    <h1>íˆ¬ì ê´€ë¦¬</h1>
    <select id="userSelect" onchange="changeUser()">
        <option value="ìœ¤ì„±ì¼">ìœ¤ì„±ì¼ (ì•„ë¹ )</option>
        <option value="ìœ¤ì±„í˜„">ìœ¤ì±„í˜„ (ë”¸)</option>
        <option value="ìœ¤ì‹œí™˜">ìœ¤ì‹œí™˜ (ì•„ë“¤)</option>
        <option value="ê°€ì¡±ì „ì²´">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± ì „ì²´</option>
    </select>
</header>

<div id="tab-portfolio" class="container active">
    <div class="card">
        <h3>ì˜¤ëŠ˜ì˜ ìì‚°</h3>
        <div class="big-text" id="totalAsset">0ì›</div>
        <div class="flex-row">
            <span class="sub-text">ì´ ì†ìµ</span>
            <span id="totalProfit" class="up">0ì› (0%)</span>
        </div>
        <div class="divider"></div>
        <div class="flex-row">
            <span class="sub-text">ì˜ˆìˆ˜ê¸ˆ</span>
            <span>
                <span id="cashHoldings">0ì›</span>
                <button class="edit-cash-btn" onclick="openCashEditModal()">ìˆ˜ì •</button>
            </span>
        </div>
        <div class="flex-row"><span class="sub-text">ì£¼ì‹ í‰ê°€ê¸ˆ</span><span id="stockHoldings">0ì›</span></div>
    </div>

    <div class="card">
        <h3>ìì‚° ë¹„ì¤‘</h3>
        <div class="chart-container">
            <canvas id="donutChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>ë³´ìœ  ì¢…ëª©</h3>
        <div id="stockList"></div>
    </div>
</div>

<div id="tab-performance" class="container">
    <div class="card">
        <h3>ë²¤ì¹˜ë§ˆí‚¹ ë¹„êµ (ëˆ„ì  ìˆ˜ìµë¥ )</h3>
        <div class="sub-text" style="margin-bottom:10px; font-size:12px;">* ê¸°ê°„ë³„ ì‹œê°„ê°€ì¤‘ ìˆ˜ìµë¥  ì§€ìˆ˜í™” (ì‹œì‘ì¼=1000)</div>
        <div class="chart-container">
            <canvas id="lineChart"></canvas>
        </div>
    </div>
    
    <div class="card">
        <h3>ì—°ë„ë³„ ì†ìµ</h3>
        <select id="yearSelect" onchange="renderRealizedDetail()" style="margin-bottom:10px; padding:5px;">
            <option value="2025">2025ë…„</option>
        </select>
        <div id="realizedProfitList"></div>
    </div>
</div>

<div id="tab-balance" class="container">
    <div class="card">
        <h3>ìƒì„¸ ì”ê³ </h3>
        <div class="table-wrap">
            <table id="balanceTable">
                <thead>
                    <tr>
                        <th>ì¢…ëª©ëª…</th>
                        <th>í‰ê°€ì†ìµ(ì›)</th>
                        <th>ìˆ˜ìµë¥ </th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>í‰ë‹¨ê°€</th>
                        <th>í˜„ì¬ê°€</th>
                        <th>í‰ê°€ê¸ˆì•¡</th>
                        <th>ë¹„ì¤‘</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="tab-history" class="container">
    <div class="card">
        <h3>ê±°ë˜ ì¶”ê°€</h3>
        <div class="form-group">
            <label>ë‚ ì§œ</label>
            <input type="date" id="inputDate">
        </div>
        <div class="form-group">
            <label>ê±°ë˜ì</label>
            <select id="inputUser">
                <option value="ìœ¤ì„±ì¼">ìœ¤ì„±ì¼</option>
                <option value="ìœ¤ì±„í˜„">ìœ¤ì±„í˜„</option>
                <option value="ìœ¤ì‹œí™˜">ìœ¤ì‹œí™˜</option>
            </select>
        </div>
        <div class="form-group">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>í‹°ì»¤</label>
                    <input type="text" id="inputTicker" placeholder="AAPL" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div style="flex:1;">
                    <label>ìœ í˜•</label>
                    <select id="inputType">
                        <option value="ë§¤ìˆ˜">ë§¤ìˆ˜</option>
                        <option value="ë§¤ë„">ë§¤ë„</option>
                        <option value="ì…ê¸ˆ">ì…ê¸ˆ</option>
                        <option value="ì¶œê¸ˆ">ì¶œê¸ˆ</option>
                        <option value="ë°°ë‹¹">ë°°ë‹¹</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>ì¢…ëª©ëª…</label>
            <input type="text" id="inputName" placeholder="ì• í”Œ">
        </div>
        <div class="form-group">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>ìˆ˜ëŸ‰</label>
                    <input type="number" id="inputQty" placeholder="0">
                </div>
                <div style="flex:1;">
                    <label>ë‹¨ê°€/ê¸ˆì•¡</label>
                    <input type="number" id="inputPrice" placeholder="USD/KRW">
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>í™˜ìœ¨ (ì…ë ¥ ì•ˆí•˜ë©´ ìë™)</label>
            <input type="number" id="inputFx" placeholder="ì˜ˆ: 1400">
        </div>
        <div class="form-group">
            <label>ë§¤ë§¤ì¼ì§€</label>
            <textarea id="inputMemo" rows="2"></textarea>
        </div>
        <button class="btn-primary" onclick="submitTransaction()">ê±°ë˜ ì €ì¥</button>
    </div>

    <div class="card">
        <h3>ìµœê·¼ ê±°ë˜ ë‚´ì—­</h3>
        
        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="date" id="startDate" style="flex:1; padding: 8px; border: 1px solid #ddd; border-radius: 8px;">
                <span>~</span>
                <input type="date" id="endDate" style="flex:1; padding: 8px; border: 1px solid #ddd; border-radius: 8px;">
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="filterHistory()" style="flex: 1; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold;">ì¡°íšŒ</button>
                <button onclick="resetHistory()" style="flex: 1; padding: 10px; background: #999; color: white; border: none; border-radius: 8px; font-weight: bold;">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div id="historyList">
            <p style="text-align:center; color:#999;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>
</div>

<nav>
    <div class="nav-item active" onclick="switchTab('portfolio')">
        <span class="nav-icon">ğŸ“Š</span>í¬íŠ¸í´ë¦¬ì˜¤
    </div>
    <div class="nav-item" onclick="switchTab('performance')">
        <span class="nav-icon">ğŸ“ˆ</span>íˆ¬ìì„±ê³¼
    </div>
    <div class="nav-item" onclick="switchTab('balance')">
        <span class="nav-icon">ğŸ’°</span>ì”ê³ 
    </div>
    <div class="nav-item" onclick="switchTab('history')">
        <span class="nav-icon">ğŸ“</span>ê±°ë˜ë‚´ì—­
    </div>
</nav>

<!-- ì˜ˆìˆ˜ê¸ˆ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="cashEditModal" class="modal">
    <div class="modal-content">
        <h3>ì˜ˆìˆ˜ê¸ˆ ì”ê³  ìˆ˜ì •</h3>
        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
            í˜„ì¬ ì‹¤ì œ ê³„ì¢Œì— ìˆëŠ” í˜„ê¸ˆ ì”ê³ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
            ì…ë ¥í•œ ê¸ˆì•¡ìœ¼ë¡œ ì¥ë¶€ê°€ ìë™ ë³´ì •ë©ë‹ˆë‹¤.
        </p>
        
        <div class="input-group">
            <label>ì›í™” ì˜ˆìˆ˜ê¸ˆ (KRW)</label>
            <input type="number" id="edit-krw" placeholder="ì˜ˆ: 1000000">
        </div>
        
        <div class="input-group">
            <label>ë‹¬ëŸ¬ ì˜ˆìˆ˜ê¸ˆ (USD)</label>
            <input type="number" id="edit-usd" step="0.01" placeholder="ì˜ˆ: 50.25">
        </div>
        
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeCashEditModal()">ì·¨ì†Œ</button>
            <button class="btn-save" onclick="saveCashEdit()">ì €ì¥</button>
        </div>
    </div>
</div>

<script>
    // ============================================
    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ë¶€
    // â€» ìˆ˜ì • ì‹œ ì£¼ì˜: ì´ ë³€ìˆ˜ë“¤ì€ ì•± ì „ì²´ì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤
    // ============================================
    
    /**
     * CURRENT_EXCHANGE_RATE
     * - í˜„ì¬ í™˜ìœ¨ (USD/KRW)
     * - ê¸°ë³¸ê°’: 1450ì›
     * - ìë™ ì—…ë°ì´íŠ¸: processMarketData()ì—ì„œ ì‹œì¥ ë°ì´í„°ì˜ ìµœì‹  í™˜ìœ¨ë¡œ ê°±ì‹ 
     * - ì‚¬ìš©ì²˜: ë¯¸êµ­ ì£¼ì‹ ê±°ë˜ë‚´ì—­ì˜ ì›í™” í™˜ì‚°
     */
    let CURRENT_EXCHANGE_RATE = 1450;
    
    /**
     * GOOGLE_SCRIPT_URL
     * - êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ URL
     * - âš ï¸ ì¤‘ìš”: ì—¬ê¸°ì— ë³¸ì¸ì˜ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì›¹ ì•± URLì„ ì…ë ¥í•˜ì„¸ìš”
     * - í˜•ì‹: https://script.google.com/macros/s/[ìŠ¤í¬ë¦½íŠ¸ID]/exec
     * - ì—­í• : ë°ì´í„° ì½ê¸°(GET) ë° ê±°ë˜ ì €ì¥(POST)
     */
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwwJAx9Xa3uHMb-aEAUkO0cPRPl88bRnSApjRwbgtyRQs0cIbNXCOXdj0w5js5KwpYNTA/exec";

    /**
     * [ë³´ì•ˆ] ë¡œê·¸ì¸ ë° ì¸ì¦ ê´€ë ¨ ë³€ìˆ˜
     */
    const STORAGE_KEY = "family_app_auth_key"; // ë¸Œë¼ìš°ì € ì €ì¥ì†Œ í‚¤ ì´ë¦„
    let currentAuthKey = localStorage.getItem(STORAGE_KEY); // ì €ì¥ëœ ì•”í˜¸ ë¶ˆëŸ¬ì˜¤ê¸°

    /**
     * ë°ì´í„° ì €ì¥ìš© ì „ì—­ ë³€ìˆ˜ë“¤
     * - ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ì €ì¥
     * - ì‚¬ìš©ì ë³€ê²½ ì‹œ ì¬ê³„ì‚°ì— ì‚¬ìš©
     */
    let LAST_FETCHED_DATA = null;   // ì„œë²„ ì‘ë‹µ ì›ë³¸ (ë°±ì—…ìš©)
    let RAW_DATA = [];              // ê±°ë˜ ë‚´ì—­ (logs ì‹œíŠ¸ ë°ì´í„°)
    let MARKET_DATA = [];           // ì‹œì¥ ë°ì´í„° (market ì‹œíŠ¸: ì£¼ê°€, í™˜ìœ¨, ì§€ìˆ˜)
    let PERFORMANCE_DATA = [];      // ì„±ê³¼ ë°ì´í„° (ìì‚°ê¸°ë¡ ì‹œíŠ¸)
    let HISTORY_DATA = [];          // ê±°ë˜ ì´ë ¥ (ì˜ˆë¹„, í˜„ì¬ ë¯¸ì‚¬ìš©)
    let currentUser = "ìœ¤ì„±ì¼";     // í˜„ì¬ ì„ íƒëœ ì‚¬ìš©ì (ë“œë¡­ë‹¤ìš´ ê°’)
    let REALIZED_EVENTS = [];       // ì‹¤í˜„ì†ìµ ì´ë²¤íŠ¸ ë°°ì—´ (ë§¤ë„/ë°°ë‹¹ ê¸°ë¡)
    let CURRENT_PRICES = [];
    
    /**
     * ì˜ˆìˆ˜ê¸ˆ ìˆ˜ì • ê´€ë ¨ ë³€ìˆ˜
     * - cashAdjustments: ì‚¬ìš©ìë³„ ì˜ˆìˆ˜ê¸ˆ ìˆ˜ì • ê¸°ë¡ ì €ì¥
     * - í˜•ì‹: { "ìœ¤ì„±ì¼": { krw: 1000000, usd: 500 } }
     */
    let cashAdjustments = {};

    /**
     * Chart.js ê°ì²´ ì €ì¥ìš©
     * - ì°¨íŠ¸ ì¬ìƒì„± ì‹œ ê¸°ì¡´ ì°¨íŠ¸ë¥¼ íŒŒê´´(destroy)í•˜ê¸° ìœ„í•´ í•„ìš”
     * - nullì´ ì•„ë‹ˆë©´ ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆë‹¤ëŠ” ì˜ë¯¸
     */
    let myDonutChart = null;        // ìì‚° ë¹„ì¤‘ ë„ë„› ì°¨íŠ¸
    let myLineChart = null;         // ë²¤ì¹˜ë§ˆí‚¹ ë¼ì¸ ì°¨íŠ¸

    // ============================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    // ============================================
    
    /**
     * showLoading()
     * - ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
     * - í˜¸ì¶œ ì‹œì : ë°ì´í„° ìš”ì²­ ì‹œì‘ ì „
     */
    function showLoading() {
        const loader = document.getElementById('loader');
        if (loader) loader.style.display = 'flex';
    }

    /**
     * hideLoading()
     * - ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
     * - í˜¸ì¶œ ì‹œì : ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ ë˜ëŠ” ì—ëŸ¬ ë°œìƒ ì‹œ
     */
    function hideLoading() {
        const loader = document.getElementById('loader');
        if (loader) loader.style.display = 'none';
    }

    // ============================================
    // [ë³´ì•ˆ] ë¡œê·¸ì¸ ë¡œì§ ì¶”ê°€
    // ============================================
    function tryLogin() {
        const input = document.getElementById('inputPass').value;
        if (!input) {
            alert("ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }
        
        // ì•”í˜¸ë¥¼ ë¸Œë¼ìš°ì €ì— ì €ì¥í•˜ê³  í™”ë©´ ê°±ì‹ 
        localStorage.setItem(STORAGE_KEY, input);
        currentAuthKey = input;
        
        document.getElementById('loginModal').style.display = "none";
        fetchData(); // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘
    }

    // ============================================
    // ì´ˆê¸°í™” (í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰)
    // ============================================
    
    /**
     * window.onload
     * - ë¸Œë¼ìš°ì €ê°€ HTMLì„ ì™„ì „íˆ ë¡œë“œí•œ í›„ ì‹¤í–‰
     * - [ìˆ˜ì •ë¨] ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸ í›„ ë°ì´í„° ìš”ì²­
     */
    window.onload = function() {
        // ë‚ ì§œ ì„¸íŒ… (ê¸°ì¡´ ê¸°ëŠ¥)
        document.getElementById('inputDate').valueAsDate = new Date();
        
        // [ë³´ì•ˆ] ì•”í˜¸ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ë°ì´í„° ë¡œë“œ, ì—†ìœ¼ë©´ ë¡œê·¸ì¸ì°½ ë„ì›€
        const loginModal = document.getElementById('loginModal');
        if (currentAuthKey) {
            if(loginModal) loginModal.style.display = "none";
            fetchData();
        } else {
            if(loginModal) loginModal.style.display = "flex";
        }
    };

    // ì‹œì¥ ë°ì´í„° ì²˜ë¦¬
    function processMarketData(data) {
        if (!data || data.length === 0) return [];
        
        let mappedData = data.map(row => {
            return {
                date: row[0],
                ticker: row[1] || '',
                sp500: Number(row[2]) || 0,
                nasdaq: Number(row[3]) || 0,
                kospi: Number(row[4]) || 0,
                usd: Number(row[5]) || 0,
                price: Number(row[6]) || 0
            };
        });

        if (mappedData.length > 0) {
            let lastData = mappedData[mappedData.length - 1];
            if (lastData.usd > 0) {
                CURRENT_EXCHANGE_RATE = lastData.usd;
                console.log("ì˜¤ëŠ˜ì˜ í™˜ìœ¨ ì ìš©: " + CURRENT_EXCHANGE_RATE + "ì›");
            }
        }

        if (typeof renderHistory === 'function') {
            renderHistory();
        }

        return mappedData;
    }

    // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function fetchData() {
        console.log("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘...");
        
        try {
            showLoading();
        } catch(e) {
            alert("ë¡œë”© í™”ë©´ í•¨ìˆ˜ ì—ëŸ¬: " + e);
        }

        if (!GOOGLE_SCRIPT_URL) {
            alert("ì˜¤ë¥˜: GOOGLE_SCRIPT_URL ë³€ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.");
            hideLoading();
            return;
        }

        // [ë³´ì•ˆ ìˆ˜ì •] URL ë’¤ì— ì•”í˜¸ë¥¼ ë¶™ì—¬ì„œ ì „ì†¡
        const requestUrl = `${GOOGLE_SCRIPT_URL}?who=${currentUser}&authKey=${currentAuthKey}`;

        fetch(requestUrl)
            .then(res => {
                if (!res.ok) {
                    throw new Error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (HTTP ìƒíƒœì½”ë“œ: " + res.status + ")");
                }
                return res.text();
            })
            .then(text => {
                // console.log("ë°›ì€ ë°ì´í„°:", text); // ë³´ì•ˆìƒ ë¡œê·¸ ì£¼ì„ ì²˜ë¦¬ ê°€ëŠ¥

                if (text.trim().startsWith("<")) {
                    throw new Error("ì„œë²„ì—ì„œ ë°ì´í„° ëŒ€ì‹  HTML(ì—ëŸ¬í˜ì´ì§€)ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.\nì•±ìŠ¤ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ ì£¼ì†Œë¥¼ í™•ì¸í•˜ê±°ë‚˜ 'ìƒˆ ë²„ì „' ë°°í¬ë¥¼ ë‹¤ì‹œ í•´ì£¼ì„¸ìš”.");
                }

                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error("ë°ì´í„°ê°€ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.\në‚´ìš©: " + text.substring(0, 50) + "...");
                }
            })
            .then(data => {
                // [ë³´ì•ˆ ì²´í¬] ì„œë²„ê°€ ì—ëŸ¬ë¥¼ ë³´ëƒˆëŠ”ì§€ í™•ì¸
                if (data.status === 'error') {
                    // ì•”í˜¸ í‹€ë¦¼ ì—ëŸ¬ì¸ ê²½ìš° ì²˜ë¦¬
                    if(data.message.includes("ë¹„ë°€ë²ˆí˜¸") || data.message.includes("ê¶Œí•œ")) {
                        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ê±°ë‚˜ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                        localStorage.removeItem(STORAGE_KEY); // ì˜ëª»ëœ ë¹„ë²ˆ ì‚­ì œ
                        location.reload(); // ìƒˆë¡œê³ ì¹¨í•´ì„œ ë¡œê·¸ì¸ì°½ ë‹¤ì‹œ ë„ì›€
                        return;
                    }
                    throw new Error("ì•±ìŠ¤ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ ì˜¤ë¥˜: " + data.message);
                }

                // ì„œë²„ì—ì„œ ì˜¨ pricesë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥!
                if (data.prices) {
                    CURRENT_PRICES = data.prices; 
                    console.log("í˜„ì¬ê°€ ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ:", CURRENT_PRICES.length, "ê±´");
                } else {
                    console.log("í˜„ì¬ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }

                LAST_FETCHED_DATA = data;
                RAW_DATA = data.logs;
                
                if (data.market) {
                    MARKET_DATA = processMarketData(data.market);
                } else {
                    MARKET_DATA = [];
                }
                
                PERFORMANCE_DATA = data.performance || [];
                processData(RAW_DATA);
                hideLoading();
            })
            .catch(err => {
                hideLoading();
                console.error(err);
                // alert("ğŸš¨ ì˜¤ë¥˜ ë°œìƒ ğŸš¨\n\n" + err); // ë„ˆë¬´ ì¦ì€ ì•Œë¦¼ ë°©ì§€
            });
    }

    // ì‚¬ìš©ì ë³€ê²½
    function changeUser() {
        const select = document.getElementById('userSelect');
        if (!select) return;

        currentUser = select.value;

        const inputUser = document.getElementById('inputUser');
        if (inputUser) {
            inputUser.value = currentUser === 'ê°€ì¡±ì „ì²´' ? 'ìœ¤ì„±ì¼' : currentUser;
        }

        if (typeof processData === 'function' && RAW_DATA && RAW_DATA.length > 0) {
            console.log(`ì‚¬ìš©ì ë³€ê²½ë¨: ${currentUser} -> í™”ë©´ ê°±ì‹ `);
            processData(RAW_DATA);
        }
    }

    // íƒ­ ì „í™˜
    function switchTab(tabName) {
        document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // ============================================
    // í•µì‹¬ ë¡œì§: ë°ì´í„° ê³„ì‚° ë° ì²˜ë¦¬
    // â€» ì´ í•¨ìˆ˜ê°€ ì•±ì˜ í•µì‹¬ì…ë‹ˆë‹¤. ìˆ˜ì • ì‹œ ë§¤ìš° ì£¼ì˜í•˜ì„¸ìš”!
    // ============================================
    
    /**
     * processData()
     * ========================================
     * ê±°ë˜ ë‚´ì—­(logs)ì„ ë¶„ì„í•˜ì—¬ í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ ìƒíƒœ ê³„ì‚°
     * ========================================
     * 
     * @param {Array} logs - 2ì°¨ì› ë°°ì—´ í˜•íƒœì˜ ê±°ë˜ ë‚´ì—­
     *   ê° í–‰ êµ¬ì¡°: [ì´ë¦„, ë‚ ì§œ, í‹°ì»¤, ì¢…ëª©ëª…, ìœ í˜•, ìˆ˜ëŸ‰, ë‹¨ê°€, í™˜ìœ¨, ë©”ëª¨]
     * 
     * ì£¼ìš” ê³„ì‚° í•­ëª©:
     * 1. ì¢…ëª©ë³„ ë³´ìœ  ìˆ˜ëŸ‰ ë° í‰ë‹¨ê°€
     * 2. ì˜ˆìˆ˜ê¸ˆ(í˜„ê¸ˆ)ì€ ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ì •í™•í•œ ê°’ì„ ì‚¬ìš© (RAW_DATA.cashInfo)
     * 3. ì£¼ì‹ í‰ê°€ê¸ˆì•¡ (ìˆ˜ëŸ‰ Ã— í˜„ì¬ê°€)
     * 4. í‰ê°€ì†ìµ (í‰ê°€ê¸ˆì•¡ - ì´ë§¤ìˆ˜ì›ê¸ˆ)
     * 5. ì´ì†ìµ = (í˜„ì¬ìì‚° + ì´ì¶œê¸ˆ) - ì´ì…ê¸ˆ
     * 
     * ê±°ë˜ ìœ í˜•ë³„ ì²˜ë¦¬:
     * - ë§¤ìˆ˜: í˜„ê¸ˆâ†“, ìˆ˜ëŸ‰â†‘, ì›ê¸ˆâ†‘
     * - ë§¤ë„: í˜„ê¸ˆâ†‘, ìˆ˜ëŸ‰â†“, ì›ê¸ˆâ†“, ì‹¤í˜„ì†ìµ ê³„ì‚°
     * - ì…ê¸ˆ: í˜„ê¸ˆâ†‘, ì´ì…ê¸ˆâ†‘
     * - ì¶œê¸ˆ: í˜„ê¸ˆâ†“, ì´ì¶œê¸ˆâ†‘
     * - ë°°ë‹¹: í˜„ê¸ˆâ†‘
     * - ì•¡ë©´ë¶„í• : ìˆ˜ëŸ‰ ì¡°ì • (ì›ê¸ˆ ìœ ì§€)
     */
    /**
    /**
     * [ì¬ìˆ˜ì •] ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ (í‰ë‹¨ê°€ ì™œê³¡ í•´ê²° ë° ê°€ì¡± ì „ì²´ í•©ì‚° ë¡œì§ ê°œì„ )
     * - 'ê°€ì¡± ì „ì²´' ì„ íƒ ì‹œ: ê°œë³„ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¨¼ì € ê³„ì‚°í•œ ë’¤, ë‹¨ìˆœ í•©ì‚°í•˜ì—¬ ì™œê³¡ ë°©ì§€
     * - ê°œë³„ ì‚¬ìš©ì ì„ íƒ ì‹œ: í•´ë‹¹ ì‚¬ìš©ìì˜ ê±°ë˜ë‚´ì—­ë§Œìœ¼ë¡œ ê³„ì‚°
     */
    function processData(logs) {
        if (!logs || logs.length === 0) return;

        // 1. ìœ í‹¸ë¦¬í‹° ë° ì´ˆê¸°í™”
        function safeFloat(val) {
            if (val === undefined || val === null || val === '') return 0;
            let str = String(val).replace(/[^\d.-]/g, '');
            let num = Number(str);
            return isNaN(num) ? 0 : num;
        }

        // í˜„ì¬ê°€ Map ë³€í™˜
        let priceMap = {};
        if (typeof CURRENT_PRICES !== 'undefined' && CURRENT_PRICES.length > 0) {
            CURRENT_PRICES.forEach(row => {
                let key = String(row[0]).trim().toUpperCase();
                let price = Number(row[1]);
                if (key) priceMap[key] = price;
            });
        }

        // â˜… [í•µì‹¬ ë³€ê²½ 1] ëª¨ë“  ì‚¬ìš©ìì˜ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ê°ê° ë”°ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì €ì¥ì†Œ
        let userPortfolios = {}; // { 'ìœ¤ì„±ì¼': { TQQQ: {...}, ... }, 'ìœ¤ì±„í˜„': ... }
        
        let totalDeposit = 0;     
        let totalWithdrawal = 0;
        let userLogs = [];

        // ë‚ ì§œìˆœ ì •ë ¬
        logs.sort((a, b) => new Date(a[1]) - new Date(b[1]));
        
        if (typeof REALIZED_EVENTS !== 'undefined') REALIZED_EVENTS = [];

        // 2. ëª¨ë“  ë¡œê·¸ë¥¼ ìˆœíšŒí•˜ë©° "ê°œë³„ ì‚¬ìš©ì"ë³„ë¡œ í¬íŠ¸í´ë¦¬ì˜¤ ê³„ì‚°
        logs.forEach(row => {
            let name = String(row[0]).trim();
            if (!name) return;

            // ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ ê³µê°„ì´ ì—†ìœ¼ë©´ ìƒì„±
            if (!userPortfolios[name]) userPortfolios[name] = {};

            let date = new Date(row[1]);
            let ticker = String(row[2]).trim().toUpperCase();
            let logName = row[3];
            let type = String(row[4]).trim();
            let qty = safeFloat(row[5]);
            let price = safeFloat(row[6]);
            let fx = safeFloat(row[7]);
            if (fx === 0) fx = 1;

            let amount = price * qty * fx;       
            let amountOrigin = price * qty;      

            // í˜„ì¬ ì„ íƒëœ í™”ë©´ì— ë§ëŠ” ë¡œê·¸ë§Œ userLogsì— ë‹´ê¸° (íˆìŠ¤í† ë¦¬ í‘œì‹œìš©)
            // ê°€ì¡± ì „ì²´ì¼ ê²½ìš° ëª¨ë“  ë¡œê·¸ í¬í•¨, ê°œë³„ ì‚¬ìš©ìì¼ ê²½ìš° í•´ë‹¹ ì‚¬ìš©ìë§Œ í¬í•¨
            let isTargetUser = (currentUser === 'ê°€ì¡± ì „ì²´' || currentUser === 'ê°€ì¡±ì „ì²´' || name === currentUser);
            
            if (isTargetUser) {
                userLogs.push({
                    date: date, ticker: ticker, name: logName, type: type,
                    amount: amount, price: price, qty: qty, userName: name
                });

                if (type === 'ì…ê¸ˆ') totalDeposit += price; 
                else if (type === 'ì¶œê¸ˆ') totalWithdrawal += price;
            }

            // --- í¬íŠ¸í´ë¦¬ì˜¤ ê³„ì‚° (í•´ë‹¹ ì‚¬ìš©ì ê²ƒë§Œ ê±´ë“œë¦¼) ---
            if (!ticker) return;
            
            // í•´ë‹¹ ì‚¬ìš©ìì˜ í•´ë‹¹ ì¢…ëª© ìŠ¬ë¡¯ ê°€ì ¸ì˜¤ê¸°
            if (!userPortfolios[name][ticker]) {
                userPortfolios[name][ticker] = { 
                    qty: 0, totalCost: 0, totalAmtOrigin: 0, name: logName,
                    splitMemory: null 
                };
            }
            let item = userPortfolios[name][ticker];

            if (type === 'ë§¤ìˆ˜') {
                item.qty += qty; 
                item.totalCost += amount; 
                item.totalAmtOrigin += amountOrigin;
            } else if (type === 'ë§¤ë„') {
                let avgCost = item.qty > 0 ? (item.totalCost / item.qty) : 0;
                let costBasis = avgCost * qty;
                let avgCostOrigin = item.qty > 0 ? (item.totalAmtOrigin / item.qty) : 0;
                let costBasisOrigin = avgCostOrigin * qty;
                
                let profit = amount - costBasis;

                // ì‹¤í˜„ì†ìµ ì´ë²¤íŠ¸ ê¸°ë¡ (í™”ë©´ì— í‘œì‹œí•  ëŒ€ìƒë§Œ)
                if (isTargetUser && typeof REALIZED_EVENTS !== 'undefined') {
                    REALIZED_EVENTS.push({
                        date: date, name: logName || ticker, ticker: ticker, 
                        profit: profit, returnRate: costBasis === 0 ? 0 : (profit / costBasis) * 100,
                        who: name
                    });
                }

                item.qty -= qty; 
                item.totalCost -= costBasis; 
                item.totalAmtOrigin -= costBasisOrigin;
                
                if (item.qty <= 0.000001) delete userPortfolios[name][ticker];

            } else if (type === 'ì•¡ë©´ë¶„í• ì…ê³ ') {
                if (item.splitMemory) {
                    item.totalCost = item.splitMemory.cost; 
                    item.totalAmtOrigin = item.splitMemory.origin;
                    item.splitMemory = null;
                } else { 
                    item.totalCost += amount; item.totalAmtOrigin += amountOrigin; 
                }
                item.qty += qty;
            } else if (type === 'ì•¡ë©´ë¶„í• ì¶œê³ ') {
                item.splitMemory = { cost: item.totalCost, origin: item.totalAmtOrigin };
                item.qty = 0; item.totalCost = 0; item.totalAmtOrigin = 0;
            }
        });

        // 3. â˜… [í•µì‹¬ ë³€ê²½ 2] í™”ë©´ì— í‘œì‹œí•  ìµœì¢… í¬íŠ¸í´ë¦¬ì˜¤ í•©ì‚° (Aggregation)
        let finalPortfolio = {}; 
        
        // í•©ì‚° ëŒ€ìƒ ìœ ì € ì„ ì •
        let targetUsers = [];
        if (currentUser === 'ê°€ì¡± ì „ì²´' || currentUser === 'ê°€ì¡±ì „ì²´') {
            targetUsers = Object.keys(userPortfolios); // ëª¨ë“  ì‚¬ìš©ì
        } else {
            targetUsers = [currentUser]; // í˜„ì¬ ì„ íƒëœ ì‚¬ìš©ìë§Œ
        }

        targetUsers.forEach(uName => {
            let uPort = userPortfolios[uName];
            if (!uPort) return;

            for (let t in uPort) {
                let uItem = uPort[t];
                
                if (!finalPortfolio[t]) {
                    finalPortfolio[t] = { 
                        qty: 0, totalCost: 0, totalAmtOrigin: 0, name: uItem.name 
                    };
                }
                
                // ë‹¨ìˆœ í•©ì‚° (ë¬¼ë¦¬ì  ê²°í•©) -> í‰ë‹¨ê°€ ì™œê³¡ ë°©ì§€
                finalPortfolio[t].qty += uItem.qty;
                finalPortfolio[t].totalCost += uItem.totalCost;      // ì´ ë§¤ìˆ˜ ê¸ˆì•¡(ì›í™”í™˜ì‚°) í•©ì‚°
                finalPortfolio[t].totalAmtOrigin += uItem.totalAmtOrigin; // ì´ ë§¤ìˆ˜ ê¸ˆì•¡(ì›í™”) í•©ì‚°
            }
        });

        // 4. ë³´ìœ  ì£¼ì‹ í‰ê°€ ë° ë¦¬ìŠ¤íŠ¸ ìƒì„±
        let stockValuation = 0;
        let balanceList = [];

        for (let t in finalPortfolio) {
            let item = finalPortfolio[t];
            let fetchedPrice = priceMap[t] || priceMap["KRX:" + t];
            let currentPriceObj = (fetchedPrice && fetchedPrice > 0) ? { price: fetchedPrice } : null;
            
            // í‰ë‹¨ê°€ëŠ” í•©ì‚°ëœ ë°ì´í„°ì—ì„œ ì—­ì‚° (ì´íˆ¬ì…ê¸ˆì•¡ / ì´ìˆ˜ëŸ‰)
            let avgPrice = item.qty > 0 ? (item.totalAmtOrigin / item.qty) : 0;
            let rawCurrentPrice = currentPriceObj ? currentPriceObj.price : avgPrice;
            
            let isKorea = !isNaN(t.charAt(0)); 
            let displayName = isKorea ? item.name : t;

            let finalPrice = rawCurrentPrice;
            if (!isKorea && typeof CURRENT_EXCHANGE_RATE !== 'undefined') {
                finalPrice = rawCurrentPrice * CURRENT_EXCHANGE_RATE;
            }

            let evalAmount = item.qty * finalPrice;
            stockValuation += evalAmount;
            
            let pnl = evalAmount - item.totalCost;
            let rate = item.totalCost === 0 ? 0 : (pnl / item.totalCost) * 100;

            balanceList.push({
                name: displayName, ticker: t, qty: item.qty,
                avgPrice: avgPrice, curPrice: rawCurrentPrice,
                evalAmt: evalAmount, profit: pnl, rate: rate, isKorea: isKorea
            });
        }

        // 5. í˜„ê¸ˆ ë° ì´ìì‚° ê³„ì‚° (GASì—ì„œ ë°›ì•„ì˜¨ cashInfo ì‚¬ìš©)
        let myCashKRW = 0;
        let myCashUSD = 0;
        
        if (typeof LAST_FETCHED_DATA !== 'undefined' && LAST_FETCHED_DATA && LAST_FETCHED_DATA.cashInfo) {
            const cInfo = LAST_FETCHED_DATA.cashInfo;
            // í‚¤ ê³µë°± ì œê±° ë§¤ì¹­ í•¨ìˆ˜
            const findData = (key) => {
                if (!key) return null;
                const clean = key.replace(/\s/g, '');
                const found = Object.keys(cInfo).find(k => k.replace(/\s/g, '') === clean);
                return found ? cInfo[found] : null;
            };

            let userData = findData(currentUser);
            if (userData) {
                myCashKRW = userData.cashKRW || 0;
                myCashUSD = userData.cashUSD || 0;
            }
        }

        let totalCashValuation = myCashKRW + (myCashUSD * CURRENT_EXCHANGE_RATE);
        let totalAsset = totalCashValuation + stockValuation;
        
        // ìµœì¢… ìˆ˜ìµ ê³„ì‚° (ì´ìì‚° + ì´ì¶œê¸ˆ - ì´ì…ê¸ˆ)
        // ì£¼ì˜: ê°€ì¡± ì „ì²´ì¼ ë•Œ totalDeposit/Withdrawalì€ ìœ„ loopì—ì„œ í•©ì‚°ë¨
        let finalProfit = (totalAsset + totalWithdrawal) - totalDeposit;
        let finalRate = totalDeposit === 0 ? 0 : (finalProfit / totalDeposit) * 100;

        // 6. DOM ì—…ë°ì´íŠ¸
        const elAsset = document.getElementById('totalAsset');
        if (elAsset) elAsset.innerText = Math.round(totalAsset).toLocaleString() + "ì›";

        const elProfit = document.getElementById('totalProfit');
        if (elProfit) {
            elProfit.innerText = `${Math.round(finalProfit).toLocaleString()}ì› (${finalRate.toFixed(1)}%)`;
            elProfit.className = finalProfit >= 0 ? 'up' : 'down';
        }

        const elCash = document.getElementById('cashHoldings');
        if (elCash) elCash.innerText = Math.round(totalCashValuation).toLocaleString() + "ì›";

        const elStock = document.getElementById('stockHoldings');
        if (elStock) elStock.innerText = Math.round(stockValuation).toLocaleString() + "ì›";

        // 7. ì°¨íŠ¸/í…Œì´ë¸” ë Œë”ë§
        let chartDataLabels = [...balanceList.map(b => b.name), 'ì˜ˆìˆ˜ê¸ˆ'];
        let chartDataValues = [...balanceList.map(b => b.evalAmt), totalCashValuation];

        if(typeof renderDonutChart === 'function') renderDonutChart(chartDataLabels, chartDataValues, totalCashValuation, totalAsset);
        if(typeof renderStockList === 'function') renderStockList(balanceList);
        if(typeof renderHistory === 'function') renderHistory(userLogs.slice().reverse().slice(0, 20));
        
        if(typeof renderBalanceTable === 'function') {
            renderBalanceTable(balanceList, totalAsset, totalCashValuation, myCashKRW, myCashUSD);
        }
        
        if(typeof renderPerformanceTable === 'function') renderPerformanceTable();

        if (typeof renderPerformanceChartFromSheet === 'function' && typeof PERFORMANCE_DATA !== 'undefined') {
            let myPerfLogs;
            // ë„ì–´ì“°ê¸° ìœ ì—°í•˜ê²Œ ì²˜ë¦¬
            if (currentUser === 'ê°€ì¡± ì „ì²´' || currentUser === 'ê°€ì¡±ì „ì²´') {
                myPerfLogs = []; 
            } else {
                myPerfLogs = PERFORMANCE_DATA.filter(row => row[1] === currentUser);
            }
            renderPerformanceChartFromSheet(myPerfLogs, MARKET_DATA);
        }
    }

    // ë„ë„› ì°¨íŠ¸ ë Œë”ë§ (ì˜ˆìˆ˜ê¸ˆ í¬í•¨)
    function renderDonutChart(labels, values, cash, totalAsset) {
        const ctx = document.getElementById('donutChart');
        if (!ctx) return;

        if (myDonutChart) myDonutChart.destroy();

        if (values.length === 0 || values.every(v => v === 0)) {
            ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
            return;
        }

        myDonutChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#FF3B30', '#FF9500', '#FFCC00', '#34C759', 
                        '#007AFF', '#5856D6', '#AF52DE', '#FF2D55',
                        '#999999'  // ì˜ˆìˆ˜ê¸ˆ ìƒ‰ìƒ (íšŒìƒ‰)
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 10,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = Math.round(context.parsed);
                                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                let percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${label}: ${value.toLocaleString()}ì› (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // ë³´ìœ  ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ì‹ ê·œ ì¶”ê°€)
    function renderStockList(balanceList) {
        const listDiv = document.getElementById('stockList');
        if (!listDiv) return;

        listDiv.innerHTML = '';

        if (balanceList.length === 0) {
            listDiv.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        balanceList.forEach(item => {
            let colorClass = item.profit >= 0 ? 'up' : 'down';
            let itemDiv = document.createElement('div');
            itemDiv.className = 'stock-item';
            
            itemDiv.innerHTML = `
                <div>
                    <div class="stock-name">${item.name}</div>
                    <div class="stock-ticker">${item.ticker}</div>
                </div>
                <div>
                    <div class="stock-price ${colorClass}">${Math.round(item.evalAmt).toLocaleString()}ì›</div>
                    <div class="stock-change ${colorClass}">${item.rate.toFixed(1)}% (${Math.round(item.profit).toLocaleString()})</div>
                </div>
            `;
            
            listDiv.appendChild(itemDiv);
        });
    }

    // ì”ê³  í…Œì´ë¸” ë Œë”ë§ (ì˜ˆìˆ˜ê¸ˆ í¬í•¨í•œ ë¹„ì¤‘ ê³„ì‚°)
    function renderBalanceTable(items, totalAsset, cash) {
        const tbody = document.querySelector('#balanceTable tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        items.forEach(item => {
            // ìˆ˜ì •: ì˜ˆìˆ˜ê¸ˆ í¬í•¨í•œ ì´ìì‚° ê¸°ì¤€ìœ¼ë¡œ ë¹„ì¤‘ ê³„ì‚°
            let weight = totalAsset > 0 ? (item.evalAmt / totalAsset) * 100 : 0;
            let color = item.profit >= 0 ? 'up' : 'down';
            
            let displayAvgPrice = "";
            let displayCurPrice = "";

            if (item.isKorea) {
                displayAvgPrice = Math.round(item.avgPrice).toLocaleString() + "ì›";
                displayCurPrice = Math.round(item.curPrice).toLocaleString() + "ì›";
            } else {
                displayAvgPrice = `<span style="color:#008000">$${Number(item.avgPrice).toFixed(2)}</span>`;
                displayCurPrice = `<span style="color:#008000">$${Number(item.curPrice).toFixed(2)}</span>`;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.name}</td>
                <td class="${color}">${Math.round(item.profit).toLocaleString()}</td>
                <td class="${color}">${item.rate.toFixed(1)}%</td>
                <td>${item.qty}</td>
                <td>${displayAvgPrice}</td>
                <td>${displayCurPrice}</td>
                <td>${Math.round(item.evalAmt).toLocaleString()}</td>
                <td>${weight.toFixed(1)}%</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ë‚ ì§œ íŒŒì‹± ìœ í‹¸ë¦¬í‹°
    function safeParseDate(val) {
        if (!val) return new Date();
        
        let d = new Date(val);
        if (!isNaN(d.getTime())) return d;

        if (typeof val === 'string') {
            let cleanStr = val.replace(/['"]/g, '').replace(/\./g, '-').trim();
            d = new Date(cleanStr);
            if (!isNaN(d.getTime())) return d;
        }
        return new Date();
    }

    function getDateNum(dateVal) {
        const d = safeParseDate(dateVal);
        const y = d.getFullYear();
        const m = d.getMonth() + 1;
        const day = d.getDate();
        return y * 10000 + m * 100 + day;
    }

    // ê±°ë˜ë‚´ì—­ ë Œë”ë§
    function renderHistory(customData = null) {
        const listDiv = document.getElementById('historyList');
        if (!listDiv) return;

        listDiv.innerHTML = '';

        let dataToRender;
        
        // customDataê°€ ì—†ìœ¼ë©´ RAW_DATAì—ì„œ í˜„ì¬ ì‚¬ìš©ì ê²ƒë§Œ í•„í„°ë§
        if (customData === null) {
            dataToRender = RAW_DATA.filter(r => r[0] === currentUser)
                                   .sort((a, b) => new Date(a[1]) - new Date(b[1]))
                                   .slice(-20)  // ìµœì‹  20ê°œ
                                   .reverse();  // ìµœì‹ ìˆœìœ¼ë¡œ
        } else {
            dataToRender = customData.slice().reverse();
        }

        if (!dataToRender || dataToRender.length === 0) {
            listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        dataToRender.forEach(row => {
            // ë°ì´í„° ê²€ì¦
            if (!row || row.length < 7) return;
            
            let dateRaw = safeParseDate(row[1]);
            
            let dateStr = dateRaw.getFullYear().toString().slice(2) + '.' + 
                          (dateRaw.getMonth()+1).toString().padStart(2,'0') + '.' + 
                          dateRaw.getDate().toString().padStart(2,'0');
            
            let ticker = row[2] || '';
            let name = row[3] || '';
            let type = row[4] || '';
            let qty = Number(row[5]) || 0;
            let rawPrice = Number(row[6]) || 0;
            
            let finalPrice = rawPrice;
            let isUS = false;

            if (type !== 'ì…ê¸ˆ' && type !== 'ì¶œê¸ˆ' && ticker) {
                if (!/^\d{6}$/.test(ticker)) {
                    isUS = true;
                    let rate = (typeof CURRENT_EXCHANGE_RATE !== 'undefined') ? CURRENT_EXCHANGE_RATE : 1450;
                    finalPrice = rawPrice * rate;
                }
            }

            let badgeColor = '#999';
            if (type === 'ë§¤ìˆ˜') badgeColor = 'var(--up)';
            else if (type === 'ë§¤ë„') badgeColor = 'var(--down)';
            else if (type === 'ë°°ë‹¹') badgeColor = '#2ECC71';
            else if (type === 'ì…ê¸ˆ' || type === 'ì¶œê¸ˆ') badgeColor = '#95a5a6';

            let priceStr = Math.round(finalPrice).toLocaleString();
            let qtyStr = qty > 0 ? `${qty}ì£¼` : '';

            let subPriceInfo = '';
            if (isUS) {
                subPriceInfo = `<span style="font-size:11px; color:#aaa; margin-left:4px;">($${rawPrice})</span>`;
            }

            let descHtml = '';
            if(type === 'ì…ê¸ˆ' || type === 'ì¶œê¸ˆ') {
                descHtml = `<div class="stock-price" style="font-weight:bold; font-size:15px;">${priceStr}ì›</div>`;
            } else if (type === 'ë°°ë‹¹') {
                descHtml = `
                    <div class="stock-price" style="font-weight:bold; color:#2ECC71; font-size:15px;">+${priceStr}ì›</div>
                    <div style="font-size:11px; color:#aaa;">(ë°°ë‹¹ê¸ˆ)</div>
                `;
            } else {
                descHtml = `
                    <div class="stock-price" style="font-weight:bold; font-size:15px;">${priceStr}ì›</div>
                    <div class="stock-change" style="color:#666; font-size:12px; margin-top:2px;">
                        ${qtyStr} ${subPriceInfo}
                    </div>
                `;
            }

            let itemDiv = document.createElement('div');
            itemDiv.className = 'stock-item';
            itemDiv.style.display = 'flex';
            itemDiv.style.justifyContent = 'space-between';
            itemDiv.style.alignItems = 'center';
            itemDiv.style.padding = '12px 0';
            itemDiv.style.borderBottom = '1px solid #eee';
            
            itemDiv.innerHTML = `
                <div style="display:flex; align-items:center; flex: 1; min-width: 0; margin-right: 10px;">
                    <div style="margin-right:12px; color:#999; font-size:12px; min-width:55px;">${dateStr}</div>
                    
                    <div style="flex: 1; min-width: 0; display:flex; align-items:center;">
                        <div style="
                            font-weight:bold; 
                            font-size:15px; 
                            white-space: nowrap; 
                            overflow: hidden; 
                            text-overflow: ellipsis; 
                            max-width: 100%; 
                        ">
                            <span class="badge" style="
                                display: inline-block;
                                vertical-align: middle;
                                margin-right:6px; 
                                font-size:11px; 
                                padding:3px 6px; 
                                border-radius:4px; 
                                color:white; 
                                background:${badgeColor};
                            ">${type}</span>
                            <span style="vertical-align: middle;">${name}</span>
                        </div>
                        ${ticker ? `<span style="font-size:12px; color:#888; margin-left:4px; white-space:nowrap;">(${ticker})</span>` : ''}
                    </div>
                </div>
                
                <div style="text-align:right; flex-shrink: 0;">
                    ${descHtml}
                </div>
            `;
            listDiv.appendChild(itemDiv);
        });
    }

    // ê±°ë˜ë‚´ì—­ í•„í„°ë§
    function filterHistory() {
        const startEl = document.getElementById('startDate');
        const endEl = document.getElementById('endDate');
    
        const startVal = startEl.value;
        const endVal = endEl.value;

        if (!startVal || !endVal) {
            alert("ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const startNum = parseInt(startVal.replace(/-/g, ''));
        const endNum = parseInt(endVal.replace(/-/g, ''));

        const filtered = RAW_DATA.filter(row => {
            if (row[0] !== currentUser) return false;

            let d = new Date(row[1]);
            if (isNaN(d)) return false;

            let y = d.getFullYear();
            let m = String(d.getMonth() + 1).padStart(2, '0');
            let day = String(d.getDate()).padStart(2, '0');
            let rowNum = parseInt(`${y}${m}${day}`);

            return rowNum >= startNum && rowNum <= endNum;
        });

        if (filtered.length === 0) {
            alert("í•´ë‹¹ ê¸°ê°„ì˜ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        renderHistory(filtered);
    }

    // ê±°ë˜ë‚´ì—­ ì´ˆê¸°í™”
    function resetHistory() {
        const startEl = document.getElementById('startDate');
        const endEl = document.getElementById('endDate');
        
        if (startEl) startEl.value = '';
        if (endEl) endEl.value = '';

        let myLogs = RAW_DATA.filter(r => r[0] === currentUser);
        myLogs.sort((a, b) => new Date(a[1]) - new Date(b[1]));
        let recent20 = myLogs.slice(-20);
        renderHistory(recent20);
    }

    // ì—°ë„ë³„ ì†ìµ ê³„ì‚°
    function calculateYearlyProfit(perfData) {
        let yearlyStats = {};

        perfData.forEach(row => {
            let date = safeParseDate(row[0]);
            let year = date.getFullYear();
            let flow = Number(row[2]);
            let asset = Number(row[3]);

            if (!yearlyStats[year]) {
                yearlyStats[year] = {
                    lastAsset: 0,
                    totalFlow: 0
                };
            }
            yearlyStats[year].lastAsset = asset;
            yearlyStats[year].totalFlow += flow;
        });

        let years = Object.keys(yearlyStats).sort();
        let prevYearAsset = 0;

        let result = years.map(year => {
            let stat = yearlyStats[year];
            let profit = stat.lastAsset - prevYearAsset - stat.totalFlow;
            prevYearAsset = stat.lastAsset;

            let investAmt = stat.totalFlow + prevYearAsset;
            let roi = (investAmt !== 0) ? (profit / investAmt * 100) : 0;

            return {
                year: year,
                profit: profit,
                roi: roi
            };
        });

        return result;
    }

    // ì„±ê³¼ í…Œì´ë¸” ë Œë”ë§
    function renderPerformanceTable() {
        const listDiv = document.getElementById('realizedProfitList');
        if (!listDiv) return;
        
        listDiv.innerHTML = '';

        REALIZED_EVENTS = [];
        let realizedMap = {};
        let portfolio = {};
        
        let totalDeposit = 0;
        let totalWithdraw = 0;

        let myLogs = RAW_DATA.filter(r => r[0] === currentUser);
        myLogs.sort((a, b) => new Date(a[1]) - new Date(b[1]));

        myLogs.forEach(row => {
            let dateStr = row[1];
            let date = new Date(dateStr);
            if (isNaN(date)) return;

            let year = date.getFullYear();
            let ticker = String(row[2]).trim();
            let name = String(row[3]).trim();
            let type = String(row[4]).trim();
            let qty = Number(row[5]);
            let price = Number(row[6]);
            let fx = row[7] ? Number(row[7]) : 1;
            
            let calcQty = qty;
            if (type === 'ë°°ë‹¹' && qty === 0) {
                calcQty = 1;
            }

            let amount = price * calcQty * fx;

            if (type === 'ì…ê¸ˆ') {
                totalDeposit += Number(row[6]);
            } else if (type === 'ì¶œê¸ˆ') {
                totalWithdraw += Number(row[6]);
            }

            if (type === 'ë§¤ìˆ˜') {
                if (!portfolio[ticker]) portfolio[ticker] = { qty: 0, totalCost: 0 };
                portfolio[ticker].qty += qty;
                portfolio[ticker].totalCost += amount;
            } 
            else if (type === 'ë§¤ë„') {
                if (portfolio[ticker] && portfolio[ticker].qty > 0) {
                    let avgCost = portfolio[ticker].totalCost / portfolio[ticker].qty;
                    let costBasis = avgCost * qty;
                    let profit = amount - costBasis;
                    
                    if (!realizedMap[year]) realizedMap[year] = 0;
                    realizedMap[year] += profit;

                    REALIZED_EVENTS.push({
                        date: date,
                        name: name || ticker,
                        ticker: ticker,
                        type: 'ë§¤ë„',
                        profit: profit,
                        returnRate: costBasis === 0 ? 0 : (profit / costBasis) * 100
                    });

                    portfolio[ticker].qty -= qty;
                    portfolio[ticker].totalCost -= costBasis;
                    if (portfolio[ticker].qty <= 0.000001) delete portfolio[ticker];
                }
            }
            else if (type === 'ë°°ë‹¹') {
                if (!realizedMap[year]) realizedMap[year] = 0;
                realizedMap[year] += amount;
                
                REALIZED_EVENTS.push({
                    date: date,
                    name: (name || ticker) + "(ë°°ë‹¹)",
                    ticker: ticker,
                    type: 'ë°°ë‹¹',
                    profit: amount,
                    returnRate: 100
                });
            }
            else if (type === 'ì•¡ë©´ë¶„í• ì¶œê³ ') {
                if (portfolio[ticker]) {
                    portfolio[ticker].qty -= qty;
                }
            }
            else if (type === 'ì•¡ë©´ë¶„í• ì…ê³ ') {
                if (!portfolio[ticker]) {
                    portfolio[ticker] = { qty: 0, totalCost: 0 };
                }
                portfolio[ticker].qty += qty;
            }
        });

        const myPerfData = PERFORMANCE_DATA.filter(row => row[1] === currentUser);
        const yearlyResults = typeof calculateYearlyProfit === 'function' 
                              ? calculateYearlyProfit(myPerfData) 
                              : [];

        let currentTotalAsset = 0;
        if (myPerfData.length > 0) {
            myPerfData.sort((a, b) => new Date(b[0]) - new Date(a[0]));
            currentTotalAsset = Number(myPerfData[0][3]);
        }
        
        let grandTotalProfit = (currentTotalAsset + totalWithdraw) - totalDeposit;
        let grandRealizedProfit = Object.values(realizedMap).reduce((a, b) => a + b, 0);

        if (yearlyResults.length === 0 && Object.keys(realizedMap).length === 0 && grandTotalProfit === 0) {
            listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        let yearSet = new Set();
        yearlyResults.forEach(y => yearSet.add(Number(y.year)));
        Object.keys(realizedMap).forEach(y => yearSet.add(Number(y)));
        let displayYears = Array.from(yearSet).sort((a, b) => b - a);

        const color = (val) => val >= 0 ? 'up' : 'down';
        const fmt = (n) => Math.round(n).toLocaleString();

        let rowsHtml = '';
        displayYears.forEach(year => {
            let totalData = yearlyResults.find(r => Number(r.year) === year);
            let totalProfit = totalData ? totalData.profit : 0;
            let realized = realizedMap[year] || 0;

            rowsHtml += `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:12px 8px; text-align:center;">${year}</td>
                    <td style="padding:12px 8px; text-align:right;" class="${color(totalProfit)}">${fmt(totalProfit)}</td>
                    <td style="padding:12px 8px; text-align:right; font-weight:bold; color:#333;">${fmt(realized)}</td>
                </tr>
            `;
        });

        let tableHtml = `
            <div style="overflow-x:auto; margin-bottom:20px; border:1px solid #eee; border-radius:8px;">
                <table style="width:100%; font-size:13px; border-collapse: collapse;">
                    <thead>
                        <tr style="background:#f8f9fa; border-bottom:2px solid #ddd; color:#555;">
                            <th style="padding:10px; text-align:center;">ê¸°ê°„</th>
                            <th style="padding:10px; text-align:right;">ì´ì†ìµ</th>
                            <th style="padding:10px; text-align:right;">ì‹¤í˜„ì†ìµ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background:#e8f4ff; border-bottom:2px solid #ccc; font-weight:bold;">
                            <td style="padding:12px 8px; text-align:center;">ì „ì²´</td>
                            <td style="padding:12px 8px; text-align:right;" class="${color(grandTotalProfit)}">${fmt(grandTotalProfit)}</td>
                            <td style="padding:12px 8px; text-align:right; color:#333;">${fmt(grandRealizedProfit)}</td>
                        </tr>
                        ${rowsHtml}
                    </tbody>
                </table>
            </div>
        `;
        
        tableHtml += `<div id="detailContainer"></div>`;
        listDiv.innerHTML = tableHtml;

        const yearSelect = document.getElementById('yearSelect');
        if (yearSelect) {
            let currentSelect = yearSelect.value;
            yearSelect.innerHTML = '';
            
            let allOpt = document.createElement('option');
            allOpt.value = 'all';
            allOpt.text = 'ì „ì²´ ë‚´ì—­';
            yearSelect.add(allOpt);

            displayYears.forEach(y => {
                let opt = document.createElement('option');
                opt.value = y;
                opt.text = y + 'ë…„ ìƒì„¸';
                if(Number(y) == Number(currentSelect)) opt.selected = true;
                yearSelect.add(opt);
            });
            
            if (!currentSelect && displayYears.length > 0) {
                yearSelect.value = displayYears[0];
            }
        }

        if (typeof renderRealizedDetail === 'function') {
            renderRealizedDetail();
        }
    }

    // ì‹¤í˜„ì†ìµ ìƒì„¸
    function renderRealizedDetail() {
        const container = document.getElementById('detailContainer');
        const yearSelect = document.getElementById('yearSelect');
        
        if (!container || !yearSelect) return;

        container.innerHTML = '';
        const selectedValue = yearSelect.value;

        const headerTitle = selectedValue === 'all' ? "ì „ì²´ ë§¤ë„ ìƒì„¸ ë‚´ì—­" : `${selectedValue}ë…„ ë§¤ë„ ìƒì„¸ ë‚´ì—­`;
        
        const detailDiv = document.createElement('div');
        detailDiv.innerHTML = `
            <div style="margin-top:20px; font-weight:bold; font-size:14px; margin-bottom:10px; border-bottom:2px solid #333; padding-bottom:5px; color:#333;">
                ğŸ“„ ${headerTitle}
            </div>`;
        container.appendChild(detailDiv);

        const filteredEvents = REALIZED_EVENTS.filter(item => {
            if (item.type !== 'ë§¤ë„') return false;
            if (selectedValue === 'all') return true;
            return item.date.getFullYear() == selectedValue;
        });

        filteredEvents.sort((a, b) => b.date - a.date);

        if(filteredEvents.length === 0) {
            let emptyDiv = document.createElement('div');
            emptyDiv.innerHTML = `<div style="text-align:center; padding:30px; color:#999; font-size:13px;">ë§¤ë„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            container.appendChild(emptyDiv);
            return;
        }

        filteredEvents.forEach(item => {
            let isProfit = item.profit >= 0;
            let profitColor = isProfit ? '#ff3b30' : '#007aff';
            let profitSign = isProfit ? '+' : '';
            let dateStr = item.date.toISOString().slice(0, 10);
            
            let rateDisplay = `<span style="font-size:12px; color:${profitColor};">${item.returnRate.toFixed(1)}%</span>`;

            let itemDiv = document.createElement('div');
            itemDiv.className = 'stock-item';
            
            itemDiv.innerHTML = `
                <div style="
                    width: 100%;
                    box-sizing: border-box;
                    display: flex; 
                    justify-content: space-between; 
                    align-items: center; 
                    padding: 12px 4px; 
                    border-bottom: 1px solid #f0f0f0;
                ">
                    <div style="text-align:left; flex: 1;">
                        <div style="font-weight:bold; font-size:14px; color:#333; margin-bottom:3px;">
                            ${item.name}
                        </div>
                        <div style="font-size:12px; color:#999;">
                            ${dateStr}
                        </div>
                    </div>

                    <div style="text-align:right; flex-shrink: 0;">
                        <div style="font-weight:bold; font-size:14px; color:${profitColor}; margin-bottom:3px;">
                            ${profitSign}${Math.round(item.profit).toLocaleString()}
                        </div>
                        <div>
                            ${rateDisplay}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(itemDiv);
        });
    }

    // ì„±ê³¼ ì°¨íŠ¸
    function renderPerformanceChartFromSheet(perfLogs, benchmarks) {
        const ctx = document.getElementById('lineChart');
        if (!ctx) return;
        
        const context = ctx.getContext('2d');
        if(myLineChart) myLineChart.destroy();

        if(benchmarks.length === 0 || perfLogs.length === 0) return;

        let labels = [];
        let dataMy = [];
        let dataK = [], dataS = [], dataN = [];

        const startDate = new Date(perfLogs[0][0]);
        let startIdx = benchmarks.findIndex(b => new Date(b.date) >= startDate);
        if(startIdx === -1) startIdx = 0;
        
        const baseK = benchmarks[startIdx].kospi || 1;
        const baseS = benchmarks[startIdx].sp500 || 1;
        const baseN = benchmarks[startIdx].nasdaq || 1;

        let myMap = {};
        perfLogs.forEach(log => {
            let d = new Date(log[0]).toISOString().split('T')[0];
            myMap[d] = Number(log[8]) * 100;
        });

        for(let i = startIdx; i < benchmarks.length; i++) {
            let b = benchmarks[i];
            let dateKey = b.date.substring(0, 10);
            
            labels.push(dateKey);
            
            dataK.push(((b.kospi - baseK) / baseK) * 100);
            dataS.push(((b.sp500 - baseS) / baseS) * 100);
            dataN.push(((b.nasdaq - baseN) / baseN) * 100);

            if (myMap.hasOwnProperty(dateKey)) {
                dataMy.push(myMap[dateKey]);
            } else {
                dataMy.push(null);
            }
        }

        myLineChart = new Chart(context, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'ğŸ† ë‚´ ìˆ˜ìµë¥ ',
                        data: dataMy,
                        borderColor: '#FF3B30',
                        backgroundColor: '#FF3B30',
                        borderWidth: 3,
                        pointRadius: 0,
                        spanGaps: true,
                        tension: 0.1,
                        fill: false
                    },
                    { 
                        label: 'S&P500', 
                        data: dataS, 
                        borderColor: '#36A2EB', 
                        backgroundColor: '#36A2EB',
                        borderWidth: 1, 
                        pointRadius: 0,
                        fill: false 
                    },
                    { 
                        label: 'NASDAQ', 
                        data: dataN, 
                        borderColor: '#9966FF', 
                        backgroundColor: '#9966FF',
                        borderWidth: 1, 
                        pointRadius: 0,
                        fill: false 
                    },
                    { 
                        label: 'KOSPI', 
                        data: dataK, 
                        borderColor: '#FF9F40', 
                        backgroundColor: '#FF9F40',
                        borderWidth: 1, 
                        pointRadius: 0,
                        fill: false 
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { display: false },
                    y: { 
                        grid: { color: '#f0f0f0' }, 
                        ticks: { callback: v => v + '%' } 
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            usePointStyle: false,
                            boxWidth: 12
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // ê±°ë˜ ì €ì¥
    function submitTransaction() {
        const btn = document.querySelector('button.btn-primary');
        btn.innerText = "ì €ì¥ ì¤‘...";
        btn.disabled = true;

        const data = {
            who: document.getElementById('inputUser').value,
            date: document.getElementById('inputDate').value,
            ticker: document.getElementById('inputTicker').value,
            name: document.getElementById('inputName').value,
            type: document.getElementById('inputType').value,
            qty: document.getElementById('inputQty').value,
            price: document.getElementById('inputPrice').value,
            fxRate: document.getElementById('inputFx').value || (document.getElementById('inputTicker').value ? '' : 1),
            memo: document.getElementById('inputMemo').value
        };

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(() => {
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ë°ì´í„° ë°˜ì˜ê¹Œì§€ ì ì‹œ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
            location.reload();
        }).catch(err => {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + err);
            btn.innerText = "ê±°ë˜ ì €ì¥";
            btn.disabled = false;
        });
    }

    // ============================================
    // [ìˆ˜ì •ë¨] ì˜ˆìˆ˜ê¸ˆ ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
    // ============================================
    
    /**
     * openCashEditModal()
     * - ëª¨ë‹¬ì„ ì—´ ë•Œ, 'ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ í˜„ì¬ ì”ê³ 'ë¥¼ ì…ë ¥ì¹¸ì— ë¯¸ë¦¬ ì±„ì›Œì¤ë‹ˆë‹¤.
     * - ì‚¬ìš©ìëŠ” í˜„ì¬ ì¸ì‹ëœ ì”ê³ ë¥¼ ë³´ê³ , ì‹¤ì œ ì”ê³ ë¡œ ìˆ˜ì •í•˜ë©´ ë©ë‹ˆë‹¤.
     */
    function openCashEditModal() {
        const modal = document.getElementById('cashEditModal');
        const krwInput = document.getElementById('edit-krw');
        const usdInput = document.getElementById('edit-usd');
        
        // ì„œë²„ ë°ì´í„°(RAW_DATA)ì—ì„œ í˜„ì¬ ë‚´ ì”ê³  ê°€ì ¸ì˜¤ê¸°
        let currentKRW = 0;
        let currentUSD = 0;

        if (typeof RAW_DATA !== 'undefined' && RAW_DATA.cashInfo && RAW_DATA.cashInfo[currentUser]) {
            currentKRW = RAW_DATA.cashInfo[currentUser].cashKRW || 0;
            currentUSD = RAW_DATA.cashInfo[currentUser].cashUSD || 0;
        }

        // ì…ë ¥ì¹¸ì— í˜„ì¬ ê°’ ì±„ì›Œë„£ê¸° (ìˆ˜ì •í•˜ê¸° í¸í•˜ë„ë¡)
        krwInput.value = Math.round(currentKRW); 
        usdInput.value = currentUSD; 
        
        modal.style.display = 'block';
    }

    /**
     * closeCashEditModal()
     * - ëª¨ë‹¬ ë‹«ê¸°
     */
    function closeCashEditModal() {
        const modal = document.getElementById('cashEditModal');
        modal.style.display = 'none';
    }

    /**
     * saveCashEdit()
     * - ì…ë ¥í•œ ì‹¤ì œ ì”ê³ ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•˜ì—¬ ë³´ì •
     * âš ï¸ [ìˆ˜ì •] WEB_APP_URL â†’ GOOGLE_SCRIPT_URLë¡œ ë³€ê²½
     */
    function saveCashEdit() {
        const krwInput = document.getElementById('edit-krw'); 
        const usdInput = document.getElementById('edit-usd');
        
        // ì…ë ¥ê°’ì´ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬
        const realKRW = parseFloat(krwInput.value) || 0;
        const realUSD = parseFloat(usdInput.value) || 0;
        
        // ìœ íš¨ì„± ê²€ì‚¬
        if (realKRW === 0 && realUSD === 0) {
            if(!confirm("ì›í™”ì™€ ë‹¬ëŸ¬ ì”ê³ ë¥¼ ëª¨ë‘ 0ì›ìœ¼ë¡œ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        }
        
        // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
        const btnSave = document.querySelector('.btn-save');
        if(btnSave) {
            btnSave.disabled = true;
            btnSave.innerText = "ì €ì¥ ì¤‘...";
        }

        // ì„œë²„ ì „ì†¡ìš© ë°ì´í„°
        const payload = {
            type: "adjustCash",     // ë°±ì—”ë“œ ì•½ì†ëœ íƒ€ì…
            who: currentUser,
            actualKRW: realKRW,
            actualUSD: realUSD
        };

        console.log("ì˜ˆìˆ˜ê¸ˆ ìˆ˜ì • ìš”ì²­:", payload);

        // Google Apps Scriptë¡œ ì „ì†¡ (ìˆ˜ì •ëœ URL ì‚¬ìš©)
        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",  // CORS ë¬¸ì œ íšŒí”¼
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(() => {
            // no-cors ëª¨ë“œì—ì„œëŠ” ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
            alert("ì˜ˆìˆ˜ê¸ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
            closeCashEditModal();
            location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        })
        .catch(err => {
            console.error("ì„œë²„ í†µì‹  ì‹¤íŒ¨:", err);
            alert("ì„œë²„ í†µì‹  ì‹¤íŒ¨: " + err.message);
        })
        .finally(() => {
            if(btnSave) {
                btnSave.disabled = false;
                btnSave.innerText = "ì €ì¥";
            }
        });
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const modal = document.getElementById('cashEditModal');
        if (event.target === modal) {
            closeCashEditModal();
        }
    }

</script>

</body>
</html>
